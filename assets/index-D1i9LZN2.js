(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))o(e);new MutationObserver(e=>{for(const s of e)if(s.type==="childList")for(const n of s.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&o(n)}).observe(document,{childList:!0,subtree:!0});function i(e){const s={};return e.integrity&&(s.integrity=e.integrity),e.referrerPolicy&&(s.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?s.credentials="include":e.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(e){if(e.ep)return;e.ep=!0;const s=i(e);fetch(e.href,s)}})();const M=200,D=200,g=32,Ot=.25,At=3,Dt=1,_t=400,X=20,vt=.1,Ct=10,K=1e3/Ct,Et=600,kt=12,st=Et*kt,nt=1800,$=.55,rt=5,Nt=2,ot=1.5,at=10,lt=60,Lt=2,Wt=.6,ct=1,ht=.045,Ht=.03,Bt=.005,Pt=.08,xt=.06,Ft=.06,zt=.55,dt=20,ft=65,ut=30,tt=3,et=15,Gt=2e-4,Yt=8e-5,Ut=.5,Xt=2,Kt={log:100,stone:50,iron:20,tool:5,coat:5,firewood:50,food:200},gt=1.5,$t=.35,Vt=.02,qt=.01,jt=3,Zt=64,Jt=.5,Qt=1.8,te=1,mt=3,ee=.02,ie=30,se=2e3,oe=-.003,ne=300,re=.01,ae=.005,le=.02,pt=200,ce=.05,he=.1,de=500,fe=5e-4,ue=100,ge=5e-5,me=5,pe=3e-4,ye=.04,we=3e3,Se=30,Re=.005,Te=5e3,Ce=.002,Ee=.2,yt=10,ke=3,Ie=.01,be=-.005,Me=1,Oe=200,Ae=2e-5,De=500,_e=50,ve=30,G=40,Y=180,wt=250,T=160,St=[0,1,2,5,10],m={GRASS:0,FOREST:1,WATER:2,STONE:3,IRON:4,RIVER:5,FERTILE:6,ROAD:7},y={LOG:"log",STONE:"stone",IRON:"iron",FIREWOOD:"firewood",TOOL:"tool",COAT:"coat",HERBS:"herbs",LEATHER:"leather",BERRIES:"berries",MUSHROOMS:"mushrooms",ROOTS:"roots",VENISON:"venison",FISH:"fish",WHEAT:"wheat",CABBAGE:"cabbage",POTATO:"potato"},j=[y.BERRIES,y.MUSHROOMS,y.ROOTS,y.VENISON,y.FISH,y.WHEAT,y.CABBAGE,y.POTATO],u={WOODEN_HOUSE:"wooden_house",STORAGE_BARN:"storage_barn",STOCKPILE:"stockpile",CROP_FIELD:"crop_field",GATHERING_HUT:"gathering_hut",HUNTING_CABIN:"hunting_cabin",FISHING_DOCK:"fishing_dock",FORESTER_LODGE:"forester_lodge",WOOD_CUTTER:"wood_cutter",BLACKSMITH:"blacksmith",TAILOR:"tailor",HERBALIST:"herbalist",MARKET:"market",SCHOOL:"school",TRADING_POST:"trading_post",ROAD:"road"},I={LABORER:"laborer",FARMER:"farmer",GATHERER:"gatherer",HUNTER:"hunter",FISHERMAN:"fisherman",FORESTER:"forester",WOOD_CUTTER:"wood_cutter",BLACKSMITH:"blacksmith",TAILOR:"tailor",HERBALIST:"herbalist",VENDOR:"vendor",TEACHER:"teacher",TRADER:"trader"},k={HOUSING:"Housing",STORAGE:"Storage",FOOD:"Food",RESOURCE:"Resource",SERVICES:"Services",INFRASTRUCTURE:"Infrastructure"};class Ne{constructor(t,i){this.onTick=t,this.onRender=i}lastTime=0;accumulator=0;running=!1;rafId=0;speedMultiplier=1;start(){this.running||(this.running=!0,this.lastTime=performance.now(),this.accumulator=0,this.loop(this.lastTime))}stop(){this.running=!1,this.rafId&&cancelAnimationFrame(this.rafId)}setSpeed(t){this.speedMultiplier=t}loop=t=>{if(!this.running)return;this.rafId=requestAnimationFrame(this.loop);const i=Math.min(t-this.lastTime,250);if(this.lastTime=t,this.speedMultiplier>0)for(this.accumulator+=i*this.speedMultiplier;this.accumulator>=K;)this.onTick(K/1e3),this.accumulator-=K;const o=this.accumulator/K;this.onRender(o)}}class Le{listeners=new Map;on(t,i){return this.listeners.has(t)||this.listeners.set(t,new Set),this.listeners.get(t).add(i),()=>this.off(t,i)}off(t,i){this.listeners.get(t)?.delete(i)}emit(t,i){this.listeners.get(t)?.forEach(o=>o(i))}clear(){this.listeners.clear()}}class It{state;constructor(t=Date.now()){this.state=t|0,this.state===0&&(this.state=1)}next(){let t=this.state;return t^=t<<13,t^=t>>17,t^=t<<5,this.state=t,(t>>>0)/4294967295}range(t,i){return t+this.next()*(i-t)}int(t,i){return Math.floor(this.range(t,i+1))}chance(t){return this.next()<t}pick(t){return t[this.int(0,t.length-1)]}shuffle(t){for(let i=t.length-1;i>0;i--){const o=this.int(0,i);[t[i],t[o]]=[t[o],t[i]]}return t}}class We{width=M;height=D;tiles;constructor(){this.tiles=new Array(M*D);for(let t=0;t<this.tiles.length;t++)this.tiles[t]={type:m.GRASS,trees:0,fertility:0,elevation:0,occupied:!1,buildingId:null,stoneAmount:0,ironAmount:0}}idx(t,i){return i*this.width+t}get(t,i){return t<0||t>=this.width||i<0||i>=this.height?null:this.tiles[this.idx(t,i)]}set(t,i,o){t<0||t>=this.width||i<0||i>=this.height||Object.assign(this.tiles[this.idx(t,i)],o)}inBounds(t,i){return t>=0&&t<this.width&&i>=0&&i<this.height}isWalkable(t,i){if(!this.inBounds(t,i))return!1;const o=this.tiles[this.idx(t,i)];return o.type!==m.WATER&&o.type!==m.RIVER}isBuildable(t,i){if(!this.inBounds(t,i))return!1;const o=this.tiles[this.idx(t,i)];return o.type!==m.WATER&&o.type!==m.RIVER&&!o.occupied}isAreaBuildable(t,i,o,e){for(let s=0;s<e;s++)for(let n=0;n<o;n++)if(!this.isBuildable(t+n,i+s))return!1;return!0}hasAdjacentWater(t,i,o,e){for(let s=-1;s<=o;s++)for(let n=-1;n<=e;n++){if(s>=0&&s<o&&n>=0&&n<e)continue;const r=this.get(t+s,i+n);if(r&&(r.type===m.WATER||r.type===m.RIVER))return!0}return!1}countForestInRadius(t,i,o){let e=0;const s=o*o;for(let n=-o;n<=o;n++)for(let r=-o;r<=o;r++){if(r*r+n*n>s)continue;const a=this.get(t+r,i+n);a&&a.type===m.FOREST&&e++}return e}consumeTreesInRadius(t,i,o){const e=o*o,s=[];for(let a=-o;a<=o;a++)for(let l=-o;l<=o;l++){if(l*l+a*a>e)continue;const c=t+l,h=i+a,d=this.get(c,h);d&&d.type===m.FOREST&&d.trees>0&&s.push({x:c,y:h})}if(s.length===0)return!1;s.sort((a,l)=>{const c=this.get(a.x,a.y),h=this.get(l.x,l.y);return c.trees-h.trees});const n=s[0],r=this.get(n.x,n.y);return r.trees-=Me,r.trees<=0&&(r.trees=0,r.type=m.GRASS),!0}plantTreeInRadius(t,i,o){const e=o*o,s=[];for(let a=-o;a<=o;a++)for(let l=-o;l<=o;l++){if(l*l+a*a>e)continue;const c=t+l,h=i+a,d=this.get(c,h);d&&d.type===m.GRASS&&!d.occupied&&s.push({x:c,y:h})}if(s.length===0)return!1;const n=s[Math.floor(Math.random()*s.length)],r=this.get(n.x,n.y);return r.type=m.FOREST,r.trees=1,!0}growTreesInRadius(t,i,o){const e=o*o;for(let s=-o;s<=o;s++)for(let n=-o;n<=o;n++){if(n*n+s*s>e)continue;const r=this.get(t+n,i+s);if(r&&r.type===m.FOREST&&r.trees<5){r.trees=Math.min(5,r.trees+1);return}}}consumeStone(t,i,o){const e=this.get(t,i);if(!e||e.type!==m.STONE)return 0;const s=Math.min(e.stoneAmount,o);return e.stoneAmount-=s,e.stoneAmount<=0&&(e.type=m.GRASS,e.stoneAmount=0),s}consumeIron(t,i,o){const e=this.get(t,i);if(!e||e.type!==m.IRON)return 0;const s=Math.min(e.ironAmount,o);return e.ironAmount-=s,e.ironAmount<=0&&(e.type=m.GRASS,e.ironAmount=0),s}markOccupied(t,i,o,e,s){for(let n=0;n<e;n++)for(let r=0;r<o;r++)this.set(t+r,i+n,{occupied:!0,buildingId:s})}getPathCost(t,i){if(!this.inBounds(t,i))return 1/0;const o=this.tiles[this.idx(t,i)];return o.type===m.ROAD?Jt:o.type===m.FOREST?Qt:te}getSpeedMultiplier(t,i){if(!this.inBounds(t,i))return ct;const o=this.tiles[this.idx(t,i)];return o.type===m.ROAD?Lt:o.type===m.FOREST?Wt:ct}placeRoad(t,i){if(!this.inBounds(t,i))return!1;const o=this.tiles[this.idx(t,i)];return o.type===m.WATER||o.type===m.RIVER?!1:(o.type=m.ROAD,o.trees=0,!0)}}class it{constructor(t){this.rng=t,this.perm=new Array(512);const i=new Array(256);for(let o=0;o<256;o++)i[o]=o;t.shuffle(i);for(let o=0;o<512;o++)this.perm[o]=i[o&255]}perm;fade(t){return t*t*t*(t*(t*6-15)+10)}lerp(t,i,o){return t+o*(i-t)}grad(t,i,o){const e=t&3,s=e<2?i:-i,n=e===0||e===3?o:-o;return s+n}noise(t,i){const o=Math.floor(t)&255,e=Math.floor(i)&255,s=t-Math.floor(t),n=i-Math.floor(i),r=this.fade(s),a=this.fade(n),l=this.perm[this.perm[o]+e],c=this.perm[this.perm[o]+e+1],h=this.perm[this.perm[o+1]+e],d=this.perm[this.perm[o+1]+e+1];return this.lerp(this.lerp(this.grad(l,s,n),this.grad(h,s-1,n),r),this.lerp(this.grad(c,s,n-1),this.grad(d,s-1,n-1),r),a)}fbm(t,i,o=4,e=2,s=.5){let n=0,r=1,a=1,l=0;for(let c=0;c<o;c++)n+=this.noise(t*a,i*a)*r,l+=r,r*=s,a*=e;return(n/l+1)*.5}}class He{generate(t,i){const o=new It(i),e=new it(o),s=new it(o),n=new it(o),r=t.width,a=t.height;for(let h=0;h<a;h++)for(let d=0;d<r;d++){const f=e.fbm(d/60,h/60,5),w=s.fbm(d/40,h/40,3),p=n.fbm(d/30,h/30,3);if(t.set(d,h,{elevation:f,fertility:w}),f<.25)t.set(d,h,{type:m.WATER});else if(p>1-$t&&f>.3){const S=Math.floor(p*5)+1;t.set(d,h,{type:m.FOREST,trees:Math.min(S,5)})}else w>.55&&f>.3?t.set(d,h,{type:m.FERTILE,fertility:w}):f>=.25&&t.set(d,h,{type:m.GRASS})}this.carveRiver(t,o);for(let h=0;h<a;h++)for(let d=0;d<r;d++){const f=t.get(d,h);f.type===m.GRASS&&f.elevation>.6&&(o.chance(Vt)?t.set(d,h,{type:m.STONE,stoneAmount:_e}):o.chance(qt)&&t.set(d,h,{type:m.IRON,ironAmount:ve}))}const l=Math.floor(r/2),c=Math.floor(a/2);for(let h=-10;h<=10;h++)for(let d=-10;d<=10;d++){const f=t.get(l+d,c+h);f&&f.type!==m.WATER&&f.type!==m.RIVER&&t.set(l+d,c+h,{type:m.GRASS,trees:0,fertility:.5})}}carveRiver(t,i){const o=t.width,e=t.height;let s=Math.floor(o*.3)+i.int(-20,20);const n=Math.floor(jt/2);for(let r=0;r<e;r++){s+=i.int(-1,1),s=Math.max(n+1,Math.min(o-n-2,s));for(let a=-n;a<=n;a++){const l=s+a;l>=0&&l<o&&t.set(l,r,{type:m.RIVER,trees:0})}}}findStartLocation(t){const i=Math.floor(t.width/2),o=Math.floor(t.height/2);for(let e=0;e<20;e++)for(let s=-e;s<=e;s++)for(let n=-e;n<=e;n++){if(Math.abs(n)!==e&&Math.abs(s)!==e)continue;const r=t.get(i+n,o+s);if(r&&r.type===m.GRASS)return{x:i+n,y:o+s}}return{x:i,y:o}}}class Be{x;y;zoom;screenWidth;screenHeight;constructor(t,i){this.screenWidth=t,this.screenHeight=i,this.zoom=Dt,this.x=M*g/2-t/2,this.y=D*g/2-i/2}resize(t,i){this.screenWidth=t,this.screenHeight=i}pan(t,i){this.x+=t,this.y+=i,this.clamp()}zoomAt(t,i,o){const e=this.zoom;this.zoom=Math.max(Ot,Math.min(At,this.zoom*(1+t)));const s=this.x+i/e,n=this.y+o/e;this.x=s-i/this.zoom,this.y=n-o/this.zoom,this.clamp()}centerOn(t,i){this.x=t*g-this.screenWidth/(2*this.zoom),this.y=i*g-this.screenHeight/(2*this.zoom),this.clamp()}clamp(){const t=M*g-this.screenWidth/this.zoom,i=D*g-this.screenHeight/this.zoom;this.x=Math.max(0,Math.min(t,this.x)),this.y=Math.max(0,Math.min(i,this.y))}screenToWorld(t,i){return{x:this.x+t/this.zoom,y:this.y+i/this.zoom}}worldToScreen(t,i){return{x:(t-this.x)*this.zoom,y:(i-this.y)*this.zoom}}screenToTile(t,i){const o=this.screenToWorld(t,i);return{x:Math.floor(o.x/g),y:Math.floor(o.y/g)}}getVisibleBounds(){const t=Math.max(0,Math.floor(this.x/g)-1),i=Math.max(0,Math.floor(this.y/g)-1),o=Math.min(M-1,Math.ceil((this.x+this.screenWidth/this.zoom)/g)+1),e=Math.min(D-1,Math.ceil((this.y+this.screenHeight/this.zoom)/g)+1);return{startX:t,startY:i,endX:o,endY:e}}}class Pe{keys=new Set;mouseX=0;mouseY=0;mouseWorldX=0;mouseWorldY=0;leftDown=!1;rightDown=!1;middleDown=!1;scrollDelta=0;clickListeners=[];canvas;constructor(t){this.canvas=t,window.addEventListener("keydown",i=>{this.keys.add(i.key.toLowerCase()),["arrowup","arrowdown","arrowleft","arrowright"," ","f3"].includes(i.key.toLowerCase())&&i.preventDefault()}),window.addEventListener("keyup",i=>{this.keys.delete(i.key.toLowerCase())}),t.addEventListener("mousemove",i=>{this.mouseX=i.clientX,this.mouseY=i.clientY}),t.addEventListener("mousedown",i=>{i.button===0&&(this.leftDown=!0),i.button===1&&(this.middleDown=!0),i.button===2&&(this.rightDown=!0)}),t.addEventListener("mouseup",i=>{i.button===0&&(this.leftDown=!1,this.clickListeners.forEach(o=>o(i.clientX,i.clientY,0))),i.button===1&&(this.middleDown=!1),i.button===2&&(this.rightDown=!1,this.clickListeners.forEach(o=>o(i.clientX,i.clientY,2)))}),t.addEventListener("wheel",i=>{i.preventDefault(),this.scrollDelta+=i.deltaY>0?-1:1},{passive:!1}),t.addEventListener("contextmenu",i=>i.preventDefault())}onClick(t){this.clickListeners.push(t)}isKeyDown(t){return this.keys.has(t.toLowerCase())}consumeScroll(){const t=this.scrollDelta;return this.scrollDelta=0,t}}class xe{constructor(t,i){this.camera=t,this.input=i,this.lastMouseX=i.mouseX,this.lastMouseY=i.mouseY}lastMouseX=0;lastMouseY=0;update(t){const i=_t*t/this.camera.zoom;let o=0,e=0;(this.input.isKeyDown("w")||this.input.isKeyDown("arrowup"))&&(e-=i),(this.input.isKeyDown("s")||this.input.isKeyDown("arrowdown"))&&(e+=i),(this.input.isKeyDown("a")||this.input.isKeyDown("arrowleft"))&&(o-=i),(this.input.isKeyDown("d")||this.input.isKeyDown("arrowright"))&&(o+=i);const s=this.input.mouseX,n=this.input.mouseY;s<X&&(o-=i*.7),s>this.camera.screenWidth-X&&(o+=i*.7),n<X&&(e-=i*.7),n>this.camera.screenHeight-X&&(e+=i*.7),this.input.middleDown&&(o+=(this.lastMouseX-s)/this.camera.zoom,e+=(this.lastMouseY-n)/this.camera.zoom),(o!==0||e!==0)&&this.camera.pan(o,e);const r=this.input.consumeScroll();r!==0&&this.camera.zoomAt(r*vt,s,n),this.lastMouseX=s,this.lastMouseY=n}}const Fe={[m.GRASS]:"#4a8c3f",[m.FOREST]:"#2d6b24",[m.WATER]:"#2856a0",[m.STONE]:"#8a8a8a",[m.IRON]:"#6b5b3e",[m.RIVER]:"#3668b5",[m.FERTILE]:"#5a9c4a",[m.ROAD]:"#8a7d6b"},ze={Housing:"#c4833e",Storage:"#8a6d3b",Food:"#6aaa3a",Resource:"#aa7733",Services:"#5577aa",Infrastructure:"#8a7d6b"};class Ge{constructor(t,i,o){this.canvas=t,this.camera=i,this.tileMap=o,this.ctx=t.getContext("2d")}ctx;terrainBuffer=null;terrainDirty=!0;invalidateTerrain(){this.terrainDirty=!0}render(t,i,o){const e=this.ctx,s=this.camera;if(e.clearRect(0,0,this.canvas.width,this.canvas.height),e.save(),e.scale(s.zoom,s.zoom),e.translate(-s.x,-s.y),this.drawTerrain(e),o?.buildings)for(const n of o.buildings)this.drawBuilding(e,n);if(o?.ghosts)for(const n of o.ghosts)e.globalAlpha=.5,e.fillStyle=n.valid?"#00ff0066":"#ff000066",e.fillRect(n.x*g,n.y*g,n.w*g,n.h*g),e.strokeStyle=n.valid?"#00ff00":"#ff0000",e.lineWidth=2,e.strokeRect(n.x*g,n.y*g,n.w*g,n.h*g),e.globalAlpha=1;if(o?.citizens)for(const n of o.citizens)this.drawCitizen(e,n,i.selectedEntity===n.id);o?.drawParticles&&o.drawParticles(e),i.nightAlpha>0&&this.drawNightOverlay(e,i,o?.buildings),e.restore()}drawNightOverlay(t,i,o){const e=this.camera.getVisibleBounds(),s=e.startX*g,n=e.startY*g,r=(e.endX-e.startX+2)*g,a=(e.endY-e.startY+2)*g;if(t.fillStyle=`rgba(10, 15, 40, ${i.nightAlpha})`,t.fillRect(s,n,r,a),i.isDawn?(t.fillStyle=`rgba(255, 180, 80, ${i.nightAlpha*.3})`,t.fillRect(s,n,r,a)):i.isDusk&&(t.fillStyle=`rgba(255, 120, 50, ${i.nightAlpha*.4})`,t.fillRect(s,n,r,a)),i.nightAlpha>.2&&o)for(const l of o){if(!l.completed||l.type!=="wooden_house")continue;const c=(l.x+l.w/2)*g,h=(l.y+l.h/2)*g,d=g*3,f=t.createRadialGradient(c,h,0,c,h,d);f.addColorStop(0,`rgba(255, 200, 80, ${i.nightAlpha*.5})`),f.addColorStop(.5,`rgba(255, 150, 50, ${i.nightAlpha*.2})`),f.addColorStop(1,"rgba(255, 150, 50, 0)"),t.globalCompositeOperation="lighter",t.fillStyle=f,t.fillRect(c-d,h-d,d*2,d*2),t.globalCompositeOperation="source-over"}}drawTerrain(t){const i=this.camera.getVisibleBounds();for(let o=i.startY;o<=i.endY;o++)for(let e=i.startX;e<=i.endX;e++){const s=this.tileMap.get(e,o);if(!s)continue;const n=e*g,r=o*g;if(t.fillStyle=Fe[s.type]||"#4a8c3f",t.fillRect(n,r,g,g),s.type===m.ROAD&&(t.fillStyle="#9a8d7b",t.fillRect(n+g/2-1,r,2,g),t.fillRect(n,r+g/2-1,g,2)),s.type===m.FOREST&&s.trees>0){const a=Math.floor(12+s.trees*14);t.fillStyle=`rgb(${a-10}, ${a+60}, ${a-10})`;const l=3+s.trees*1.4;t.beginPath(),t.arc(n+g/2,r+g/2,l,0,Math.PI*2),t.fill(),s.trees<=3&&(t.fillStyle="#5c3a1a",t.fillRect(n+g/2-1,r+g/2+2,3,5))}if(s.type===m.STONE){const a=Math.max(.3,(s.stoneAmount||50)/50);t.fillStyle="#aaa",t.beginPath(),t.arc(n+g/2,r+g/2,3+5*a,0,Math.PI*2),t.fill()}if(s.type===m.IRON){const a=Math.max(.3,(s.ironAmount||30)/30);t.fillStyle="#c4863a",t.beginPath(),t.arc(n+g/2,r+g/2,3+4*a,0,Math.PI*2),t.fill()}}}drawBuilding(t,i){const o=i.x*g,e=i.y*g,s=i.w*g,n=i.h*g,r=ze[i.category]||"#888";i.completed?(t.fillStyle=r,t.fillRect(o+1,e+1,s-2,n-2),t.strokeStyle="#333",t.lineWidth=1,t.strokeRect(o+1,e+1,s-2,n-2)):(t.fillStyle="#555",t.fillRect(o+1,e+1,s-2,n-2),t.fillStyle=r,t.globalAlpha=.6,t.fillRect(o+1,e+1,(s-2)*i.progress,n-2),t.globalAlpha=1,t.strokeStyle="#ff8800",t.lineWidth=1,t.strokeRect(o+1,e+1,s-2,n-2))}drawCitizen(t,i,o){const e=i.x*g+g/2,s=i.y*g+g/2,n=i.isChild?4:6;i.isSleeping?t.fillStyle=i.isMale?"#2a4466":"#662a44":t.fillStyle=i.isMale?"#4488cc":"#cc4488",t.beginPath(),t.arc(e,s,n,0,Math.PI*2),t.fill(),i.health<50&&(t.strokeStyle=`rgba(255, 0, 0, ${1-i.health/50})`,t.lineWidth=2,t.stroke()),i.isSleeping&&(t.fillStyle="#aaaaff",t.font="bold 10px monospace",t.fillText("z",e+n+1,s-n-1),t.font="bold 7px monospace",t.fillText("z",e+n+7,s-n-6)),i.isSick&&(t.fillStyle="#44dd44",t.font="bold 10px monospace",t.fillText("â˜ ",e-n-4,s-n-2)),i.isChatting&&(t.fillStyle="#ffffff",t.font="9px monospace",t.fillText("...",e+n+2,s-n-1)),o&&(t.strokeStyle="#ffffff",t.lineWidth=2,t.beginPath(),t.arc(e,s,n+3,0,Math.PI*2),t.stroke())}drawHUD(t,i,o){const e=this.ctx;e.fillStyle="rgba(0, 0, 0, 0.8)",e.fillRect(0,0,this.canvas.width,G),e.fillStyle="#ffffff",e.font="14px monospace";const n=["Early Spring","Mid Spring","Late Spring","Early Summer","Mid Summer","Late Summer","Early Autumn","Mid Autumn","Late Autumn","Early Winter","Mid Winter","Late Winter"][t.subSeason]||"Unknown",r=t.paused?"PAUSED":`${t.speed}x`;let a="Day",l="#ffdd44";t.isNight?(a="Night",l="#6688cc"):t.isDawn?(a="Dawn",l="#ffaa66"):t.isDusk&&(a="Dusk",l="#ff8844");let c=10;const h=26;if(e.fillText(`Year ${t.year}  ${n}`,c,h),c+=230,e.fillStyle=l,e.fillText(a,c,h),c+=60,o&&o!=="clear"){const f={storm:{label:"STORM",color:"#ff4444"},drought:{label:"DROUGHT",color:"#ddaa22"},harsh_winter:{label:"COLD SNAP",color:"#88ccff"}}[o];f&&(e.fillStyle=f.color,e.font="bold 14px monospace",e.fillText(f.label,c,h),c+=90,e.font="14px monospace")}if(e.fillStyle="#ffffff",e.fillText(`Pop: ${t.population}`,c,h),c+=90,e.fillText(`Speed: ${r}`,c,h),i){c+=110;const d=["log","stone","iron","firewood","tool","coat"],f=["Log","Stn","Irn","Fwd","Tol","Cot"];let w=0;for(const[p,S]of i)["berries","mushrooms","roots","venison","fish","wheat","cabbage","potato","food"].includes(p)&&(w+=S);e.fillText(`Food: ${Math.floor(w)}`,c,h),c+=80;for(let p=0;p<d.length;p++){const S=Math.floor(i.get(d[p])||0);e.fillText(`${f[p]}:${S}`,c,h),c+=65}}t.gameOver&&(e.fillStyle="rgba(0, 0, 0, 0.7)",e.fillRect(0,0,this.canvas.width,this.canvas.height),e.fillStyle="#ff4444",e.font="48px monospace",e.textAlign="center",e.fillText("GAME OVER",this.canvas.width/2,this.canvas.height/2-30),e.fillStyle="#ffffff",e.font="20px monospace",e.fillText("All citizens have perished.",this.canvas.width/2,this.canvas.height/2+20),e.fillText(`Survived ${t.year} years. Deaths: ${t.totalDeaths}. Births: ${t.totalBirths}.`,this.canvas.width/2,this.canvas.height/2+50),e.fillText("Press R to restart",this.canvas.width/2,this.canvas.height/2+90),e.textAlign="left")}}class Ye{nextId=1;entities=new Set;components=new Map;createEntity(){const t=this.nextId++;return this.entities.add(t),t}destroyEntity(t){this.entities.delete(t);for(const i of this.components.values())i.delete(t)}entityExists(t){return this.entities.has(t)}addComponent(t,i,o){this.components.has(i)||this.components.set(i,new Map),this.components.get(i).set(t,o)}removeComponent(t,i){this.components.get(i)?.delete(t)}getComponent(t,i){return this.components.get(i)?.get(t)}hasComponent(t,i){return this.components.get(i)?.has(t)??!1}getComponentStore(t){return this.components.get(t)}query(...t){if(t.length===0)return[...this.entities];const i=t.map(s=>this.components.get(s));if(i.some(s=>!s))return[];const o=i.map((s,n)=>({store:s,type:t[n]})).sort((s,n)=>s.store.size-n.store.size),e=[];for(const[s]of o[0].store)o.every(({store:n})=>n.has(s))&&e.push(s);return e}getAllEntities(){return[...this.entities]}getEntityCount(){return this.entities.size}}class Ue{data=[];get size(){return this.data.length}push(t){this.data.push(t),this.bubbleUp(this.data.length-1)}pop(){const t=this.data[0],i=this.data.pop();return this.data.length>0&&i&&(this.data[0]=i,this.sinkDown(0)),t}bubbleUp(t){for(;t>0;){const i=t-1>>1;if(this.data[t].f<this.data[i].f)[this.data[t],this.data[i]]=[this.data[i],this.data[t]],t=i;else break}}sinkDown(t){const i=this.data.length;for(;;){let o=t;const e=2*t+1,s=2*t+2;if(e<i&&this.data[e].f<this.data[o].f&&(o=e),s<i&&this.data[s].f<this.data[o].f&&(o=s),o!==t)[this.data[t],this.data[o]]=[this.data[o],this.data[t]],t=o;else break}}}class Xe{constructor(t){this.tileMap=t}cache=new Map;cacheOrder=[];cacheKey(t,i,o,e){return`${t},${i}-${o},${e}`}findPath(t,i,o,e){if(t===o&&i===e)return{path:[{x:o,y:e}],found:!0};const s=this.cacheKey(t,i,o,e),n=this.cache.get(s);if(n)return n;if(!this.tileMap.isWalkable(o,e)){const a=this.findNearestWalkable(o,e);if(!a)return{path:[],found:!1};o=a.x,e=a.y}const r=this.astar(t,i,o,e);for(this.cache.set(s,r),this.cacheOrder.push(s);this.cacheOrder.length>Zt;){const a=this.cacheOrder.shift();this.cache.delete(a)}return r}astar(t,i,o,e){const s=new Ue,n=new Set,r=this.tileMap.width,a={x:t,y:i,g:0,h:Math.abs(o-t)+Math.abs(e-i),f:0,parent:null};a.f=a.h,s.push(a);const l=new Map;l.set(i*r+t,0);const c=[{dx:0,dy:-1},{dx:1,dy:0},{dx:0,dy:1},{dx:-1,dy:0},{dx:1,dy:-1},{dx:1,dy:1},{dx:-1,dy:1},{dx:-1,dy:-1}];let h=0;const d=5e3;for(;s.size>0&&h<d;){h++;const f=s.pop(),w=f.y*r+f.x;if(f.x===o&&f.y===e)return{path:this.reconstructPath(f),found:!0};if(!n.has(w)){n.add(w);for(const p of c){const S=f.x+p.dx,C=f.y+p.dy;if(!this.tileMap.isWalkable(S,C))continue;const _=C*r+S;if(n.has(_)||p.dx!==0&&p.dy!==0&&(!this.tileMap.isWalkable(f.x+p.dx,f.y)||!this.tileMap.isWalkable(f.x,f.y+p.dy)))continue;const b=this.tileMap.getPathCost(S,C),N=(p.dx!==0&&p.dy!==0?1.414:1)*b,E=f.g+N,O=l.get(_);if(O!==void 0&&E>=O)continue;l.set(_,E);const A=Math.abs(o-S)+Math.abs(e-C);s.push({x:S,y:C,g:E,h:A,f:E+A,parent:f})}}}return{path:[],found:!1}}reconstructPath(t){const i=[];let o=t;for(;o;)i.unshift({x:o.x,y:o.y}),o=o.parent;return i}findNearestWalkable(t,i){for(let o=1;o<=5;o++)for(let e=-o;e<=o;e++)for(let s=-o;s<=o;s++)if(!(Math.abs(s)!==o&&Math.abs(e)!==o)&&this.tileMap.isWalkable(t+s,i+e))return{x:t+s,y:i+e};return null}clearCache(){this.cache.clear(),this.cacheOrder=[]}}class Ke{constructor(t,i){this.world=t,this.tileMap=i}update(){const t=this.world.getComponentStore("position"),i=this.world.getComponentStore("movement");if(!(!t||!i))for(const[o,e]of i){const s=t.get(o);if(!s||!e.path||e.path.length===0){e&&(e.moving=!1);continue}e.moving=!0;const n=e.path[0],r=n.x*g+g/2,a=n.y*g+g/2,l=r-s.pixelX,c=a-s.pixelY,h=Math.sqrt(l*l+c*c),d=this.tileMap.getSpeedMultiplier(s.tileX,s.tileY),f=(e.speed||ot)*d*g/Ct;h<=f?(s.pixelX=r,s.pixelY=a,s.tileX=n.x,s.tileY=n.y,e.path.shift(),e.path.length===0&&(e.moving=!1)):(s.pixelX+=l/h*f,s.pixelY+=c/h*f,s.tileX=Math.floor(s.pixelX/g),s.tileY=Math.floor(s.pixelY/g))}}}function Z(R,t,i,o){const e=i-R,s=o-t;return Math.sqrt(e*e+s*s)}class $e{game;tickCounter=0;constructor(t){this.game=t}update(){if(this.tickCounter++,this.tickCounter%5!==0)return;const t=this.game.world,i=t.query("citizen","position","needs","movement");for(const o of i){const e=t.getComponent(o,"citizen"),s=t.getComponent(o,"needs"),n=t.getComponent(o,"movement"),r=t.getComponent(o,"worker");if(n.stuckTicks===void 0&&(n.stuckTicks=0),e.isSleeping===void 0&&(e.isSleeping=!1),s.energy===void 0&&(s.energy=100),s.lastSocialTick===void 0&&(s.lastSocialTick=0),e.chatTimer===void 0&&(e.chatTimer=0),!(e.chatTimer>0&&(e.chatTimer-=5,n.stuckTicks=0,s.lastSocialTick=this.game.state.tick,e.chatTimer>0))){if(this.game.state.tick-s.lastSocialTick>se&&(s.happiness=Math.max(0,s.happiness+oe)),e.isSleeping)if(n.stuckTicks=0,s.energy>=100&&!this.game.state.isNight)e.isSleeping=!1;else if(s.food<et)e.isSleeping=!1;else continue;if(n.path&&n.path.length>0){n.stuckTicks=0;continue}if(n.stuckTicks++,n.stuckTicks>50){r?.workplaceId!==null&&r?.workplaceId!==void 0&&this.unassignWorker(o,r),this.forceWander(o),n.stuckTicks=0;continue}if(e.isChild){this.handleChildAI(o,e,s,n);continue}if(r){if(s.food<et){this.seekFood(o);continue}if(s.warmth<25){this.seekWarmth(o);continue}if(s.energy<dt){this.goSleep(o,e);continue}if(this.game.state.isNight){this.goSleep(o,e);continue}if(s.food<ft){this.eatMeal(o);continue}if(r.workplaceId!==null){if(this.isNearBuilding(o,r.workplaceId)){n.stuckTicks=0;continue}this.goToBuilding(o,r.workplaceId)||this.unassignWorker(o,r);continue}if(r.profession===I.LABORER){const a=this.findNearestConstructionSite(o);if(a!==null){if(this.isNearBuilding(o,a)){n.stuckTicks=0;continue}if(this.goToBuilding(o,a))continue}}this.trySocialize(o,e,s)||this.wander(o)}}}}handleChildAI(t,i,o,e){if(!i.isSleeping){if(o.food<et){this.seekFood(t);return}if(this.game.state.isNight||o.energy<dt){this.goSleep(t,i);return}if(o.food<ft){this.eatMeal(t);return}if(!i.isEducated){const s=this.findBuilding(u.SCHOOL);if(s!==null){if(this.isNearBuilding(t,s)){e.stuckTicks=0;return}if(this.goToBuilding(t,s))return}}this.wander(t)}}eatMeal(t){if(this.game.getTotalFood()>=tt){const e=this.game.world.getComponent(t,"needs");e.recentDiet||(e.recentDiet=[]);const s=this.game.removeFoodPreferVariety(tt,e.recentDiet);if(s.eaten>0){e.food=Math.min(100,e.food+ut),e.recentDiet.push(s.type),e.recentDiet.length>yt&&e.recentDiet.shift();return}}const o=this.findNearestStorage(t);o!==null?this.isNearBuilding(t,o)||this.goToBuilding(t,o):this.wander(t)}seekFood(t){if(this.game.getTotalFood()>0){const e=this.game.world.getComponent(t,"needs");e.recentDiet||(e.recentDiet=[]);const s=this.game.removeFoodPreferVariety(tt,e.recentDiet);if(s.eaten>0){e.food=Math.min(100,e.food+ut),e.recentDiet.push(s.type),e.recentDiet.length>yt&&e.recentDiet.shift();return}}const o=this.findNearestStorage(t);o!==null?this.isNearBuilding(t,o)||this.goToBuilding(t,o):this.wander(t)}seekWarmth(t){this.goHome(t)}trySocialize(t,i,o){if(Math.random()>ee)return!1;const e=this.game.world.getComponent(t,"position"),s=this.game.world.getComponentStore("citizen"),n=this.game.world.getComponentStore("position");if(!s||!n)return!1;for(const[r]of s){if(r===t)continue;const a=n.get(r);if(!a)continue;const l=Math.abs(e.tileX-a.tileX),c=Math.abs(e.tileY-a.tileY);if(l<=mt&&c<=mt)return i.chatTimer=ie,o.lastSocialTick=this.game.state.tick,o.happiness=Math.min(100,o.happiness+.5),!0}return!1}goSleep(t,i){const o=this.game.world.getComponent(t,"family");if(o?.homeId!=null){if(this.isNearBuilding(t,o.homeId)){i.isSleeping=!0;const s=this.game.world.getComponent(t,"needs");s&&(s.warmth=Math.min(100,s.warmth+.1));const n=this.game.world.getComponent(t,"movement");n.stuckTicks=0;return}if(this.goToBuilding(t,o.homeId))return}const e=this.findBuilding(u.WOODEN_HOUSE);if(e!==null){if(this.isNearBuilding(t,e)){i.isSleeping=!0;return}if(this.goToBuilding(t,e))return}if(this.game.world.getComponent(t,"needs").energy<5){i.isSleeping=!0;return}this.wander(t)}goHome(t){const i=this.game.world.getComponent(t,"family");if(i?.homeId!=null){if(this.isNearBuilding(t,i.homeId)){const e=this.game.world.getComponent(t,"needs");e&&(e.warmth=Math.min(100,e.warmth+.1));const s=this.game.world.getComponent(t,"movement");s.stuckTicks=0;return}if(this.goToBuilding(t,i.homeId))return}const o=this.findBuilding(u.WOODEN_HOUSE);o!==null&&(this.isNearBuilding(t,o)||this.goToBuilding(t,o))||this.wander(t)}goToBuilding(t,i){const o=this.game.world.getComponent(t,"position"),e=this.game.world.getComponent(i,"position");if(!e)return!1;const s=this.game.world.getComponent(i,"building"),n=s?.width||1,r=s?.height||1,a=[{x:e.tileX+Math.floor(n/2),y:e.tileY+r},{x:e.tileX+Math.floor(n/2),y:e.tileY-1},{x:e.tileX-1,y:e.tileY+Math.floor(r/2)},{x:e.tileX+n,y:e.tileY+Math.floor(r/2)},{x:e.tileX,y:e.tileY+r},{x:e.tileX+n-1,y:e.tileY+r}];for(const l of a){if(!this.game.tileMap.isWalkable(l.x,l.y))continue;const c=this.game.pathfinder.findPath(o.tileX,o.tileY,l.x,l.y);if(c.found&&c.path.length>0){const h=this.game.world.getComponent(t,"movement");return h.path=c.path,h.targetEntity=i,h.stuckTicks=0,!0}}return!1}isNearBuilding(t,i){const o=this.game.world.getComponent(t,"position"),e=this.game.world.getComponent(i,"position");if(!o||!e)return!1;const s=this.game.world.getComponent(i,"building"),n=s?.width||1,r=s?.height||1,a=o.tileX-e.tileX,l=o.tileY-e.tileY;return a>=-2&&a<=n+1&&l>=-2&&l<=r+1}unassignWorker(t,i){if(i.workplaceId===null)return;const o=this.game.world.getComponent(i.workplaceId,"building");o?.assignedWorkers&&(o.assignedWorkers=o.assignedWorkers.filter(e=>e!==t)),i.workplaceId=null,i.profession=I.LABORER}wander(t){const i=this.game.world.getComponent(t,"position");for(let o=0;o<3;o++){const e=this.game.rng.int(-6,6),s=this.game.rng.int(-6,6);if(e===0&&s===0)continue;const n=Math.max(1,Math.min(this.game.tileMap.width-2,i.tileX+e)),r=Math.max(1,Math.min(this.game.tileMap.height-2,i.tileY+s));if(!this.game.tileMap.isWalkable(n,r))continue;const a=this.game.pathfinder.findPath(i.tileX,i.tileY,n,r);if(a.found&&a.path.length>1){const l=this.game.world.getComponent(t,"movement");l.path=a.path,l.targetEntity=null,l.stuckTicks=0;return}}}forceWander(t){const i=this.game.world.getComponent(t,"position");for(let o=0;o<8;o++){const e=this.game.rng.int(-15,15),s=this.game.rng.int(-15,15);if(Math.abs(e)<3&&Math.abs(s)<3)continue;const n=Math.max(1,Math.min(this.game.tileMap.width-2,i.tileX+e)),r=Math.max(1,Math.min(this.game.tileMap.height-2,i.tileY+s));if(!this.game.tileMap.isWalkable(n,r))continue;const a=this.game.pathfinder.findPath(i.tileX,i.tileY,n,r);if(a.found&&a.path.length>1){const l=this.game.world.getComponent(t,"movement");l.path=a.path,l.targetEntity=null;return}}}findNearestConstructionSite(t){const i=this.game.world.getComponent(t,"position"),o=this.game.world.getComponentStore("building");if(!o)return null;let e=null,s=1/0;for(const[n,r]of o){if(r.completed||r.constructionProgress>=1)continue;const a=this.game.world.getComponent(n,"position");if(!a)continue;const l=Z(i.tileX,i.tileY,a.tileX,a.tileY);l<s&&(s=l,e=n)}return e}findBuilding(t){const i=this.game.world.getComponentStore("building");if(!i)return null;for(const[o,e]of i)if(e.type===t&&e.completed)return o;return null}findNearestStorage(t){const i=this.game.world.getComponent(t,"position"),o=this.game.world.getComponentStore("building");if(!o)return null;let e=null,s=1/0;for(const[n,r]of o){if(!r.completed||r.type!==u.STORAGE_BARN&&r.type!==u.STOCKPILE&&r.type!==u.MARKET)continue;const a=this.game.world.getComponent(n,"position"),l=Z(i.tileX,i.tileY,a.tileX,a.tileY);l<s&&(s=l,e=n)}return e}}class Ve{game;constructor(t){this.game=t}update(){const t=this.game.world,i=t.getComponentStore("building");if(i)for(const[o,e]of i){if(e.completed)continue;const s=t.getComponent(o,"position"),n=this.findNearbyWorkers(s.tileX,s.tileY,e.width,e.height);if(n.length===0)continue;if(e.constructionProgress===0&&!e.materialsDelivered){const a=e,l=this.game.getResource("log")>=(a.costLog||0),c=this.game.getResource("stone")>=(a.costStone||0),h=this.game.getResource("iron")>=(a.costIron||0);if(l&&c&&h)this.game.removeResource("log",a.costLog||0),this.game.removeResource("stone",a.costStone||0),this.game.removeResource("iron",a.costIron||0),e.materialsDelivered=!0;else continue}if(!e.materialsDelivered&&e.constructionProgress===0)continue;let r=n.length*.5;for(const a of n)t.getComponent(a,"citizen")?.isEducated&&(r+=.25);e.constructionProgress+=r/(e.constructionWork||100),e.constructionProgress>=1&&(e.constructionProgress=1,e.completed=!0,this.initCompletedBuilding(o,e))}}findNearbyWorkers(t,i,o,e){const s=this.game.world,n=[],r=s.getComponentStore("position"),a=s.getComponentStore("worker");if(!r||!a)return n;for(const[l,c]of a){const h=r.get(l);if(!h)continue;const d=h.tileX-t,f=h.tileY-i;d>=-2&&d<=o+1&&f>=-2&&f<=e+1&&n.push(l)}return n}initCompletedBuilding(t,i){const o=this.game.world;(i.isStorage||i.storageCapacity)&&(o.hasComponent(t,"storage")||o.addComponent(t,"storage",{inventory:new Map,capacity:i.storageCapacity||5e3})),o.addComponent(t,"producer",{timer:0,active:!1,workerCount:0}),i.type==="wooden_house"&&o.addComponent(t,"house",{residents:[],firewood:0,warmthLevel:50,maxResidents:i.residents||5})}}const qe=[{buildingType:u.GATHERING_HUT,inputs:{},outputs:{[y.BERRIES]:3,[y.MUSHROOMS]:2,[y.ROOTS]:2},cooldownTicks:120,seasonalMultiplier:!0,gatherFromRadius:!0},{buildingType:u.HUNTING_CABIN,inputs:{},outputs:{[y.VENISON]:4,[y.LEATHER]:1},cooldownTicks:150,seasonalMultiplier:!0,gatherFromRadius:!0},{buildingType:u.FISHING_DOCK,inputs:{},outputs:{[y.FISH]:5},cooldownTicks:100},{buildingType:u.FORESTER_LODGE,inputs:{},outputs:{[y.LOG]:3},cooldownTicks:120,gatherFromRadius:!0},{buildingType:u.WOOD_CUTTER,inputs:{[y.LOG]:1},outputs:{[y.FIREWOOD]:3},cooldownTicks:80},{buildingType:u.BLACKSMITH,inputs:{[y.IRON]:1,[y.LOG]:1},outputs:{[y.TOOL]:1},cooldownTicks:200},{buildingType:u.TAILOR,inputs:{[y.LEATHER]:2},outputs:{[y.COAT]:1},cooldownTicks:200},{buildingType:u.HERBALIST,inputs:{},outputs:{[y.HERBS]:2},cooldownTicks:150,gatherFromRadius:!0},{buildingType:u.CROP_FIELD,inputs:{},outputs:{[y.WHEAT]:8,[y.CABBAGE]:5,[y.POTATO]:5},cooldownTicks:200,seasonalMultiplier:!0}],H=[{name:"Early Spring",temperature:5,cropGrowth:0,gatheringRate:.3,snow:!1,dayLength:.5},{name:"Mid Spring",temperature:12,cropGrowth:.5,gatheringRate:.7,snow:!1,dayLength:.6},{name:"Late Spring",temperature:18,cropGrowth:.8,gatheringRate:1,snow:!1,dayLength:.7},{name:"Early Summer",temperature:24,cropGrowth:1,gatheringRate:1,snow:!1,dayLength:.8},{name:"Mid Summer",temperature:28,cropGrowth:1,gatheringRate:1,snow:!1,dayLength:.9},{name:"Late Summer",temperature:25,cropGrowth:.9,gatheringRate:.9,snow:!1,dayLength:.8},{name:"Early Autumn",temperature:18,cropGrowth:.5,gatheringRate:.7,snow:!1,dayLength:.6},{name:"Mid Autumn",temperature:10,cropGrowth:0,gatheringRate:.3,snow:!1,dayLength:.5},{name:"Late Autumn",temperature:3,cropGrowth:0,gatheringRate:0,snow:!1,dayLength:.4},{name:"Early Winter",temperature:-5,cropGrowth:0,gatheringRate:0,snow:!0,dayLength:.3},{name:"Mid Winter",temperature:-15,cropGrowth:0,gatheringRate:0,snow:!0,dayLength:.25},{name:"Late Winter",temperature:-10,cropGrowth:0,gatheringRate:0,snow:!0,dayLength:.3}];class je{game;foresterTimers=new Map;constructor(t){this.game=t}update(){const t=this.game.world,i=t.getComponentStore("building"),o=t.getComponentStore("producer");if(!i||!o)return;if(this.game.state.isNight){for(const[,s]of o)s.active=!1;return}const e=H[this.game.state.subSeason];for(const[s,n]of o){const r=i.get(s);if(!r||!r.completed)continue;const a=qe.find(w=>w.buildingType===r.type);if(!a)continue;const l=this.countWorkersAtBuilding(s);if(n.workerCount=l,l===0){n.active=!1;continue}n.active=!0;let c=l/(r.maxWorkers||1);c=Math.min(1,c);const h=this.countEducatedWorkers(s);h>0&&(c*=1+h/l*(gt-1)),this.buildingNeedsTools(r.type)&&(this.game.getResource(y.TOOL)>0?this.game.removeResource(y.TOOL,Gt*l):c*=Ut),a.seasonalMultiplier&&(r.type===u.CROP_FIELD?(c*=e.cropGrowth,c*=this.game.weatherSystem.getCropWeatherMult()):c*=e.gatheringRate);const f=t.getComponent(s,"position");if(a.gatherFromRadius&&f){const w=f.tileX+Math.floor(r.width/2),p=f.tileY+Math.floor(r.height/2),S=r.workRadius||30,C=this.game.tileMap.countForestInRadius(w,p,S);c*=Math.min(1,C/50)}if(!(c<=0)){if(n.timer+=c,n.timer>=a.cooldownTicks){n.timer=0;let w=!0;for(const[p,S]of Object.entries(a.inputs))if(this.game.getResource(p)<S){w=!1;break}if(!w)continue;if(a.gatherFromRadius&&f){const p=f.tileX+Math.floor(r.width/2),S=f.tileY+Math.floor(r.height/2),C=r.workRadius||30;this.game.tileMap.consumeTreesInRadius(p,S,C)}for(const[p,S]of Object.entries(a.inputs))this.game.removeResource(p,S);for(const[p,S]of Object.entries(a.outputs)){let C=S;h>0&&(r.type===u.WOOD_CUTTER||r.type===u.BLACKSMITH)&&(C=Math.ceil(C*gt)),this.game.addResource(p,C)}}r.type===u.FORESTER_LODGE&&f&&this.updateForester(s,f,r,l)}}}updateForester(t,i,o,e){this.foresterTimers.has(t)||this.foresterTimers.set(t,{replant:0,grow:0});const s=this.foresterTimers.get(t),n=i.tileX+Math.floor(o.width/2),r=i.tileY+Math.floor(o.height/2),a=o.workRadius||30;s.replant+=e,s.replant>=Oe&&(s.replant=0,this.game.tileMap.plantTreeInRadius(n,r,a)),s.grow+=e,s.grow>=De&&(s.grow=0,this.game.tileMap.growTreesInRadius(n,r,a))}buildingNeedsTools(t){return[u.HUNTING_CABIN,u.FISHING_DOCK,u.FORESTER_LODGE,u.WOOD_CUTTER,u.BLACKSMITH,u.CROP_FIELD].includes(t)}countWorkersAtBuilding(t){const o=this.game.world.getComponentStore("worker");if(!o)return 0;let e=0;for(const[,s]of o)s.workplaceId===t&&e++;return e}countEducatedWorkers(t){const i=this.game.world,o=i.getComponentStore("worker"),e=i.getComponentStore("citizen");if(!o||!e)return 0;let s=0;for(const[n,r]of o)r.workplaceId===t&&e.get(n)?.isEducated&&s++;return s}}class Ze{game;constructor(t){this.game=t}update(){const t=this.game.world,i=t.query("citizen","needs","position"),o=H[this.game.state.subSeason];for(const e of i){const s=t.getComponent(e,"needs"),n=t.getComponent(e,"citizen");s.energy===void 0&&(s.energy=100),n.isSleeping===void 0&&(n.isSleeping=!1),n.isSleeping?(s.energy=Math.min(100,s.energy+zt),s.food-=ht*.5):(s.energy=Math.max(0,s.energy-Ft),s.food-=ht),s.food=Math.max(0,s.food);let r=Ht;o.temperature<0?r*=1+Math.abs(o.temperature)/10:o.temperature>15&&(s.warmth=Math.min(100,s.warmth+.02),r=0),this.game.getResource(y.COAT)>0?this.game.removeResource(y.COAT,Yt):r*=Xt;const l=t.getComponent(e,"family");if(l?.homeId!=null&&this.isNearHome(e,l.homeId)){const h=t.getComponent(l.homeId,"house");h&&h.warmthLevel>30&&(r*=.2,s.warmth=Math.min(100,s.warmth+.05))}if(s.warmth-=r,s.warmth=Math.max(0,s.warmth),s.food<=0&&(s.health-=Pt),s.warmth<=0&&o.temperature<5&&(s.health-=xt),s.food>50&&s.warmth>50&&s.energy>30&&s.health<100&&(s.health+=.005),s.health<80&&this.game.getResource("herbs")>0&&this.game.rng.chance(.001)&&(this.game.removeResource("herbs",1),s.health=Math.min(100,s.health+10)),n.age>60&&(s.health-=Bt*(n.age-60)/20),s.health=Math.max(0,Math.min(100,s.health)),s.food<30||s.warmth<30||s.health<50||s.energy<15?s.happiness=Math.max(0,s.happiness-.01):s.food>70&&s.warmth>70&&s.health>70&&s.energy>50&&(s.happiness=Math.min(100,s.happiness+.005)),s.recentDiet&&s.recentDiet.length>=3){const h=new Set(s.recentDiet).size;h>=ke?s.happiness=Math.min(100,s.happiness+Ie):h<=1&&(s.happiness=Math.max(0,s.happiness+be))}s.health<=0&&this.killCitizen(e)}}isNearHome(t,i){const o=this.game.world.getComponent(t,"position"),e=this.game.world.getComponent(i,"position");if(!o||!e)return!1;const s=this.game.world.getComponent(i,"building"),n=s?.width||1,r=s?.height||1,a=o.tileX-e.tileX,l=o.tileY-e.tileY;return a>=-2&&a<=n+1&&l>=-2&&l<=r+1}killCitizen(t){const o=this.game.world.getComponent(t,"citizen")?.name||"Unknown",e=this.game.world.getComponent(t,"family");if(e?.partnerId){const n=this.game.world.getComponent(e.partnerId,"family");n&&(n.partnerId=null)}const s=this.game.world.getComponent(t,"worker");if(s?.workplaceId){const n=this.game.world.getComponent(s.workplaceId,"building");n?.assignedWorkers&&(n.assignedWorkers=n.assignedWorkers.filter(r=>r!==t))}if(e?.homeId){const n=this.game.world.getComponent(e.homeId,"house");n?.residents&&(n.residents=n.residents.filter(r=>r!==t))}this.game.world.destroyEntity(t),this.game.state.totalDeaths++,this.game.eventBus.emit("citizen_died",{id:t,name:o})}}class Je{game;tickCounter=0;constructor(t){this.game=t}update(){this.tickCounter++,this.tickCounter%30===0&&(this.restockHouses(),this.distributeFromMarket(),this.spoilFood())}restockHouses(){const i=this.game.world.getComponentStore("house");if(i)for(const[o,e]of i){if(e.firewood<10){const s=20-e.firewood,n=this.game.removeResource(y.FIREWOOD,s);e.firewood+=n}e.firewood>0?(e.warmthLevel=Math.min(100,e.warmthLevel+2),e.firewood-=.05,e.firewood<0&&(e.firewood=0)):e.warmthLevel=Math.max(0,e.warmthLevel-5)}}distributeFromMarket(){const t=this.game.world,i=t.getComponentStore("building");if(i)for(const[o,e]of i){if(e.type!==u.MARKET||!e.completed)continue;const s=t.getComponent(o,"position");if(!s)continue;const n=t.query("citizen","position","needs");for(const r of n){const a=t.getComponent(r,"position"),l=a.tileX-s.tileX,c=a.tileY-s.tileY;if(Math.abs(l)<=(e.workRadius||40)&&Math.abs(c)<=(e.workRadius||40)){const h=t.getComponent(r,"needs");h.happiness=Math.min(100,h.happiness+.5)}}}}spoilFood(){const i=this.hasBuildingType(u.STORAGE_BARN)?Ee:1,o=["food",...j];for(const e of o){const s=this.game.getResource(e);if(s>0){const n=Math.max(.1,s*Ce*i);this.game.removeResource(e,n)}}}hasBuildingType(t){const i=this.game.world.getComponentStore("building");if(!i)return!1;for(const[,o]of i)if(o.type===t&&o.completed)return!0;return!1}}const Qe=500,Rt=.01,ti=.15;class ei{game;tickCounter=0;constructor(t){this.game=t}update(){this.tickCounter++,this.tickCounter%st===0&&this.ageCitizens(),this.tickCounter%100===0&&(this.formFamilies(),this.checkBirths(),this.assignHomes(),this.autoAssignWorkers(),this.educateChildren()),this.tickCounter%Qe===0&&this.tickCounter>st&&this.checkNomadArrival()}ageCitizens(){const t=this.game.world,i=t.getComponentStore("citizen");if(i){for(const[o,e]of i)if(e.age++,e.age>=at&&e.isChild&&(e.isChild=!1,t.hasComponent(o,"worker")||t.addComponent(o,"worker",{profession:I.LABORER,workplaceId:null,carrying:null,carryAmount:0,task:null})),e.age>lt){const s=(e.age-lt)*.02;if(this.game.rng.chance(s)){const n=t.getComponent(o,"needs");n&&(n.health=0)}}}}formFamilies(){const t=this.game.world,i=t.query("citizen","family"),o=[];for(const r of i){const a=t.getComponent(r,"citizen"),l=t.getComponent(r,"family");!a.isChild&&a.age>=16&&l.partnerId===null&&o.push({id:r,isMale:a.isMale})}const e=o.filter(r=>r.isMale),s=o.filter(r=>!r.isMale),n=Math.min(e.length,s.length);for(let r=0;r<n;r++){const a=e[r].id,l=s[r].id,c=t.getComponent(a,"family"),h=t.getComponent(l,"family");c.partnerId=l,h.partnerId=a}}checkBirths(){const t=this.game.world,i=t.query("citizen","family","position");for(const o of i){const e=t.getComponent(o,"citizen"),s=t.getComponent(o,"family");if(!(e.isMale||e.isChild)&&s.partnerId!==null&&!(s.childrenIds.length>=3)&&this.game.rng.chance(.03)){if(s.homeId===null)continue;const n=t.getComponent(s.homeId,"house");if(!n||n.residents.length>=n.maxResidents)continue;const r=t.getComponent(o,"position"),a=this.spawnCitizen(r.tileX,r.tileY,!0);s.childrenIds.push(a),n.residents.push(a);const l=t.getComponent(a,"family");l&&(l.homeId=s.homeId),this.game.state.totalBirths++,this.game.eventBus.emit("citizen_born",{id:a})}}}spawnCitizen(t,i,o){const e=this.game.world,s=e.createEntity(),n=this.game.rng.chance(.5);e.addComponent(s,"position",{tileX:t,tileY:i,pixelX:t*g+g/2,pixelY:i*g+g/2});const r=["John","William","Thomas","Richard","Henry","Robert","Edward","George","James","Arthur"],a=["Mary","Elizabeth","Anne","Margaret","Catherine","Jane","Alice","Eleanor","Rose","Sarah"];return e.addComponent(s,"citizen",{name:n?this.game.rng.pick(r):this.game.rng.pick(a),age:o?1:this.game.rng.int(18,30),isMale:n,isChild:o,isEducated:!1,isSleeping:!1}),e.addComponent(s,"movement",{path:[],speed:ot,targetEntity:null,moving:!1}),e.addComponent(s,"needs",{food:80,warmth:100,health:100,happiness:80,energy:80,recentDiet:[]}),e.addComponent(s,"family",{partnerId:null,childrenIds:[],homeId:null}),e.addComponent(s,"renderable",{sprite:null,layer:10,animFrame:0,visible:!0}),o||e.addComponent(s,"worker",{profession:I.LABORER,workplaceId:null,carrying:null,carryAmount:0,task:null}),s}assignHomes(){const t=this.game.world,i=t.getComponentStore("house"),o=t.getComponentStore("family");if(!(!i||!o))for(const[e,s]of o){if(s.homeId!==null)continue;const n=t.getComponent(e,"citizen");if(!(!n||n.isChild)){for(const[r,a]of i)if(t.getComponent(r,"building")?.completed&&!(a.residents.length>=a.maxResidents)){if(s.homeId=r,a.residents.push(e),s.partnerId!==null){const c=t.getComponent(s.partnerId,"family");c&&c.homeId===null&&(c.homeId=r,a.residents.push(s.partnerId))}break}}}}autoAssignWorkers(){const t=this.game.world,i=t.getComponentStore("building"),o=t.getComponentStore("worker");if(!(!i||!o))for(const[e,s]of i){if(!s.completed||s.maxWorkers===0||(s.assignedWorkers?.length||0)>=s.maxWorkers)continue;const r=t.getComponent(e,"position");if(!r)continue;const a=[];for(const[l,c]of o){if(c.workplaceId!==null||c.profession!==I.LABORER)continue;const h=t.getComponent(l,"citizen");if(!h||h.isChild)continue;const d=t.getComponent(l,"position");if(!d)continue;const f=Math.abs(d.tileX-r.tileX)+Math.abs(d.tileY-r.tileY);a.push({id:l,dist:f})}a.sort((l,c)=>l.dist-c.dist);for(const l of a){if((s.assignedWorkers?.length||0)>=s.maxWorkers)break;const c=t.getComponent(l.id,"position"),h=r.tileX+Math.floor((s.width||1)/2),d=r.tileY+(s.height||1);if(!this.game.pathfinder.findPath(c.tileX,c.tileY,h,d).found)continue;const w=o.get(l.id);w.workplaceId=e,w.profession=this.getProfessionForBuilding(s.type),s.assignedWorkers||(s.assignedWorkers=[]),s.assignedWorkers.push(l.id)}}}educateChildren(){const t=this.game.world,i=t.getComponentStore("building");if(!i)return;let o=!1;for(const[,s]of i)if(s.type===u.SCHOOL&&s.completed&&(s.assignedWorkers?.length||0)>0){o=!0;break}if(!o)return;const e=t.getComponentStore("citizen");if(e)for(const[,s]of e)s.isChild&&s.age>=at-1&&!s.isEducated&&(s.isEducated=!0)}checkNomadArrival(){const i=this.hasBuildingType(u.TRADING_POST)?Rt*2:Rt;if(!this.game.rng.chance(i))return;const o=this.game.rng.int(2,5),e=this.game.rng.int(0,3);let s,n;switch(e){case 0:s=this.game.rng.int(20,M-20),n=5;break;case 1:s=M-5,n=this.game.rng.int(20,D-20);break;case 2:s=this.game.rng.int(20,M-20),n=D-5;break;default:s=5,n=this.game.rng.int(20,D-20);break}for(let a=0;a<10;a++)for(let l=-a;l<=a;l++)for(let c=-a;c<=a;c++)this.game.tileMap.isWalkable(s+c,n+l)&&(s=s+c,n=n+l,a=10,l=a,c=a);const r=[];for(let a=0;a<o;a++){const l=this.game.rng.int(-2,2),c=this.game.rng.int(-2,2),h=Math.max(1,Math.min(M-2,s+l)),d=Math.max(1,Math.min(D-2,n+c)),f=this.spawnCitizen(h,d,!1);r.push(f)}if(this.game.rng.chance(ti)){const a=this.game.rng.pick(r),l=this.game.world.getComponent(a,"needs");l&&(l.isSick=!0,l.diseaseTicks=0)}this.game.eventBus.emit("nomads_arrived",{count:o})}hasBuildingType(t){const i=this.game.world.getComponentStore("building");if(!i)return!1;for(const[,o]of i)if(o.type===t&&o.completed)return!0;return!1}getProfessionForBuilding(t){return{[u.CROP_FIELD]:I.FARMER,[u.GATHERING_HUT]:I.GATHERER,[u.HUNTING_CABIN]:I.HUNTER,[u.FISHING_DOCK]:I.FISHERMAN,[u.FORESTER_LODGE]:I.FORESTER,[u.WOOD_CUTTER]:I.WOOD_CUTTER,[u.BLACKSMITH]:I.BLACKSMITH,[u.TAILOR]:I.TAILOR,[u.HERBALIST]:I.HERBALIST,[u.MARKET]:I.VENDOR,[u.SCHOOL]:I.TEACHER,[u.TRADING_POST]:I.TRADER}[t]||I.LABORER}}class ii{game;constructor(t){this.game=t}update(){const t=this.game.state;t.tickInSubSeason++,t.tickInSubSeason>=Et&&(t.tickInSubSeason=0,t.subSeason++,t.subSeason>=kt&&(t.subSeason=0,t.year++,this.game.eventBus.emit("new_year",{year:t.year})),this.game.eventBus.emit("season_changed",{subSeason:t.subSeason,data:H[t.subSeason]})),this.updateDayNight()}updateDayNight(){const t=this.game.state,i=H[t.subSeason],o=t.tick%nt;t.dayProgress=o/nt;const e=i.dayLength,s=(1-e)/2+e*.1,n=(1-e)/2+e*.9,r=(1+e)/2,a=(1-e)/2,l=t.dayProgress;if(l<a)t.isNight=!0,t.isDawn=!1,t.isDusk=!1,t.nightAlpha=$;else if(l<s){t.isNight=!1,t.isDawn=!0,t.isDusk=!1;const c=(l-a)/(s-a);t.nightAlpha=$*(1-c)}else if(l<n)t.isNight=!1,t.isDawn=!1,t.isDusk=!1,t.nightAlpha=0;else if(l<r){t.isNight=!1,t.isDawn=!1,t.isDusk=!0;const c=(l-n)/(r-n);t.nightAlpha=$*c}else t.isNight=!0,t.isDawn=!1,t.isDusk=!1,t.nightAlpha=$}getCurrentSeason(){return H[this.game.state.subSeason]}isDaytime(){return!this.game.state.isNight}}class si{game;merchant=null;lastVisit=0;constructor(t){this.game=t}update(){const t=this.game.state.tick;this.hasBuildingType(u.TRADING_POST)&&(!this.merchant&&t-this.lastVisit>st*.8&&this.game.rng.chance(.002)&&this.spawnMerchant(t),this.merchant?.active&&t>=this.merchant.departing&&(this.merchant.active=!1,this.merchant=null,this.game.eventBus.emit("merchant_departed",{})))}spawnMerchant(t){const i=this.game.rng,o=new Map,e=new Map,s=[y.LOG,y.STONE,y.IRON,y.TOOL,y.COAT,y.FIREWOOD];for(let r=0;r<3;r++){const a=i.pick(s);o.set(a,i.int(20,80))}const n=[y.BERRIES,y.VENISON,y.FISH,y.LOG,y.LEATHER];for(let r=0;r<2;r++){const a=i.pick(n);e.set(a,i.int(30,100))}this.merchant={arriving:t,departing:t+600,wares:o,wants:e,active:!0},this.lastVisit=t,this.game.eventBus.emit("merchant_arrived",{wares:o,wants:e})}getMerchant(){return this.merchant}executeTrade(t,i,o,e){if(!this.merchant?.active||this.game.getResource(t)<i)return!1;const s=this.merchant.wares.get(o)||0;return s<e?!1:(this.game.removeResource(t,i),this.game.addResource(o,e),this.merchant.wares.set(o,s-e),!0)}hasBuildingType(t){const i=this.game.world.getComponentStore("building");if(!i)return!1;for(const[,o]of i)if(o.type===t&&o.completed)return!0;return!1}}class oi{game;scanIndex=0;TILES_PER_TICK=200;buildingDecayCounter=0;constructor(t){this.game=t}update(){const t=this.game.tileMap,i=M*D;for(let o=0;o<this.TILES_PER_TICK;o++){const e=this.scanIndex;this.scanIndex=(this.scanIndex+1)%i;const s=t.tiles[e];if(s.type===m.GRASS&&!s.occupied&&Math.random()<Ae){const n=e%M,r=Math.floor(e/M);this.hasAdjacentForest(n,r)&&(s.type=m.FOREST,s.trees=1)}s.type===m.FOREST&&s.trees<5&&Math.random()<2e-4&&(s.trees=Math.min(5,s.trees+1))}this.buildingDecayCounter++,this.buildingDecayCounter>=10&&(this.buildingDecayCounter=0,this.decayBuildings())}decayBuildings(){const i=this.game.world.getComponentStore("building");if(i)for(const[o,e]of i)e.completed&&(e.durability===void 0&&(e.durability=ue),e.durability-=fe*10,e.durability<=0&&this.collapseBuilding(o,e))}collapseBuilding(t,i){const o=this.game.world;if(i.assignedWorkers)for(const n of i.assignedWorkers){const r=o.getComponent(n,"worker");r&&(r.workplaceId=null,r.profession="laborer")}const e=o.getComponent(t,"house");if(e?.residents)for(const n of e.residents){const r=o.getComponent(n,"family");r&&(r.homeId=null)}const s=o.getComponent(t,"position");if(s)for(let n=0;n<(i.height||1);n++)for(let r=0;r<(i.width||1);r++)this.game.tileMap.set(s.tileX+r,s.tileY+n,{occupied:!1,buildingId:null});o.destroyEntity(t),this.game.eventBus.emit("building_collapsed",{name:i.name})}hasAdjacentForest(t,i){const o=this.game.tileMap;for(let e=-1;e<=1;e++)for(let s=-1;s<=1;s++){if(s===0&&e===0)continue;const n=o.get(t+s,i+e);if(n&&n.type===m.FOREST)return!0}return!1}}class ni{game;tickCounter=0;constructor(t){this.game=t}update(){if(this.tickCounter++,this.tickCounter%5!==0)return;const t=this.game.world,i=t.query("citizen","needs","position");for(const o of i){const e=t.getComponent(o,"needs"),s=t.getComponent(o,"citizen");if(e.isSick===void 0&&(e.isSick=!1),e.diseaseTicks===void 0&&(e.diseaseTicks=0),e.immunityTicks===void 0&&(e.immunityTicks=0),e.immunityTicks>0&&(e.immunityTicks-=5),e.isSick)e.diseaseTicks+=5,e.health-=ye*5,e.energy!==void 0&&(e.energy=Math.max(0,e.energy-.02*5)),e.diseaseTicks>=we&&this.cureCitizen(e),this.trySpreadDisease(o);else if(e.immunityTicks<=0){let n=ge*5;e.food<30&&(n*=3),e.warmth<30&&(n*=2),e.health<50&&(n*=2),Math.random()<n&&(e.isSick=!0,e.diseaseTicks=0,this.game.eventBus.emit("citizen_sick",{id:o,name:s.name}))}}this.applyHerbalistCures()}trySpreadDisease(t){const i=this.game.world,o=i.getComponent(t,"position"),e=i.query("citizen","needs","position");for(const s of e){if(s===t)continue;const n=i.getComponent(s,"needs");if(n.isSick||n.immunityTicks>0)continue;const r=i.getComponent(s,"position");if(Z(o.tileX,o.tileY,r.tileX,r.tileY)<=me&&Math.random()<pe*5){n.isSick=!0,n.diseaseTicks=0;const l=i.getComponent(s,"citizen");this.game.eventBus.emit("citizen_sick",{id:s,name:l?.name||"Unknown"})}}}applyHerbalistCures(){const t=this.game.world,i=t.getComponentStore("building");if(i)for(const[o,e]of i){if(e.type!==u.HERBALIST||!e.completed||this.game.getResource(y.HERBS)<=0||!(e.assignedWorkers&&e.assignedWorkers.length>0))continue;const n=t.getComponent(o,"position");if(!n)continue;const r=n.tileX+Math.floor(e.width/2),a=n.tileY+Math.floor(e.height/2),l=t.query("citizen","needs","position");for(const c of l){const h=t.getComponent(c,"needs");if(!h.isSick)continue;const d=t.getComponent(c,"position");if(Z(r,a,d.tileX,d.tileY)<=Se&&Math.random()<Re*5){this.game.removeResource(y.HERBS,1),this.cureCitizen(h);const w=t.getComponent(c,"citizen");this.game.eventBus.emit("citizen_cured",{id:c,name:w?.name||"Unknown"})}}}}cureCitizen(t){t.isSick=!1,t.diseaseTicks=0,t.immunityTicks=Te}}const Tt=300;class ri{game;particles=[];tickCounter=0;constructor(t){this.game=t}update(){this.tickCounter++,this.tickCounter%3===0&&(this.spawnSmoke(),this.spawnWeatherParticles());for(let t=this.particles.length-1;t>=0;t--){const i=this.particles[t];i.x+=i.vx,i.y+=i.vy,i.life--,i.alpha=Math.max(0,i.life/i.maxLife),i.life<=0&&this.particles.splice(t,1)}}spawnSmoke(){if(this.particles.length>=Tt)return;const t=this.game.world,i=t.getComponentStore("house");if(i)for(const[o,e]of i){if(e.warmthLevel<=20||Math.random()>.3)continue;const s=t.getComponent(o,"position"),n=t.getComponent(o,"building");if(!s||!n)continue;const r=(s.tileX+n.width/2)*g,a=s.tileY*g-4;this.particles.push({x:r+(Math.random()-.5)*4,y:a,vx:(Math.random()-.5)*.3,vy:-.3-Math.random()*.3,life:40+Math.floor(Math.random()*20),maxLife:60,size:2+Math.random()*2,color:"#888888",alpha:.5})}}spawnWeatherParticles(){if(this.particles.length>=Tt)return;const t=H[this.game.state.subSeason],o=this.game.camera.getVisibleBounds();if(t.snow)for(let s=0;s<3;s++){const n=(o.startX+Math.random()*(o.endX-o.startX))*g,r=o.startY*g;this.particles.push({x:n,y:r,vx:(Math.random()-.5)*.5,vy:.5+Math.random()*.5,life:80+Math.floor(Math.random()*40),maxLife:120,size:1.5+Math.random()*1.5,color:"#ffffff",alpha:.7})}const e=this.game.state.subSeason;if(e>=6&&e<=8&&Math.random()<.3){const s=(o.startX+Math.random()*(o.endX-o.startX))*g,n=o.startY*g,r=["#cc6622","#dd8833","#aa4411","#eebb44"];this.particles.push({x:s,y:n,vx:(Math.random()-.5)*.8,vy:.3+Math.random()*.3,life:100+Math.floor(Math.random()*50),maxLife:150,size:2+Math.random()*2,color:r[Math.floor(Math.random()*r.length)],alpha:.8})}}draw(t){for(const i of this.particles)t.globalAlpha=i.alpha,t.fillStyle=i.color,t.beginPath(),t.arc(i.x,i.y,i.size,0,Math.PI*2),t.fill();t.globalAlpha=1}}class ai{game;tickCounter=0;currentWeather="clear";weatherTimer=0;constructor(t){this.game=t}update(){if(this.tickCounter++,this.currentWeather!=="clear"){if(this.weatherTimer--,this.applyWeatherEffects(),this.weatherTimer<=0){const i=this.currentWeather;this.currentWeather="clear",this.game.eventBus.emit("weather_cleared",{previous:i})}return}if(this.tickCounter%ne!==0)return;H[this.game.state.subSeason];const t=this.game.state.subSeason;if(this.game.rng.chance(re)){this.currentWeather="storm",this.weatherTimer=pt,this.game.eventBus.emit("weather_started",{type:"storm"});return}if(t>=3&&t<=5&&this.game.rng.chance(ae)){this.currentWeather="drought",this.weatherTimer=de,this.game.eventBus.emit("weather_started",{type:"drought"});return}if(t>=9&&t<=11&&this.game.rng.chance(le)){this.currentWeather="harsh_winter",this.weatherTimer=pt,this.game.eventBus.emit("weather_started",{type:"harsh_winter"});return}}applyWeatherEffects(){const t=this.game.world;if(this.currentWeather==="storm"){const i=t.getComponentStore("building");if(i)for(const[,s]of i)s.completed&&(s.durability===void 0&&(s.durability=100),s.durability=Math.max(0,s.durability-ce));const o=t.getComponentStore("producer");if(o&&i)for(const[s,n]of o)i.get(s)?.type===u.CROP_FIELD&&(n.timer=Math.max(0,n.timer-he));const e=t.query("citizen","needs");for(const s of e){const n=t.getComponent(s,"needs");t.getComponent(s,"citizen")?.isSleeping||(n.warmth=Math.max(0,n.warmth-.05))}}if(this.currentWeather==="harsh_winter"){const i=t.query("citizen","needs");for(const o of i){const e=t.getComponent(o,"needs");e.warmth=Math.max(0,e.warmth-.03)}}}getCropWeatherMult(){return this.currentWeather==="drought"?.1:this.currentWeather==="storm"?.5:1}}const J={[u.WOODEN_HOUSE]:{type:u.WOODEN_HOUSE,name:"Wooden House",category:k.HOUSING,width:3,height:3,costLog:16,costStone:8,costIron:0,maxWorkers:0,workRadius:0,constructionWork:100,residents:5,description:"A warm wooden house. Shelters up to 5 residents."},[u.STORAGE_BARN]:{type:u.STORAGE_BARN,name:"Storage Barn",category:k.STORAGE,width:4,height:4,costLog:32,costStone:12,costIron:0,maxWorkers:0,workRadius:0,constructionWork:120,isStorage:!0,storageCapacity:6e3,description:"Stores food and goods. Capacity: 6000."},[u.STOCKPILE]:{type:u.STOCKPILE,name:"Stockpile",category:k.STORAGE,width:4,height:4,costLog:0,costStone:0,costIron:0,maxWorkers:0,workRadius:0,constructionWork:10,isStorage:!0,storageCapacity:5e3,description:"Open-air storage for raw materials. Capacity: 5000."},[u.CROP_FIELD]:{type:u.CROP_FIELD,name:"Crop Field",category:k.FOOD,width:8,height:8,costLog:0,costStone:0,costIron:0,maxWorkers:4,workRadius:0,constructionWork:30,description:"Grow crops. Plant in spring, harvest in autumn. 4 workers."},[u.GATHERING_HUT]:{type:u.GATHERING_HUT,name:"Gathering Hut",category:k.FOOD,width:3,height:3,costLog:30,costStone:12,costIron:0,maxWorkers:4,workRadius:30,constructionWork:80,requiresForest:!0,description:"Gathers berries, mushrooms, and roots from nearby forest. 4 workers."},[u.HUNTING_CABIN]:{type:u.HUNTING_CABIN,name:"Hunting Cabin",category:k.FOOD,width:3,height:3,costLog:38,costStone:10,costIron:0,maxWorkers:3,workRadius:30,constructionWork:80,description:"Hunts deer for venison and leather. 3 workers."},[u.FISHING_DOCK]:{type:u.FISHING_DOCK,name:"Fishing Dock",category:k.FOOD,width:3,height:4,costLog:30,costStone:16,costIron:0,maxWorkers:4,workRadius:0,constructionWork:90,requiresWater:!0,description:"Catches fish from nearby water. Must be placed adjacent to water. 4 workers."},[u.FORESTER_LODGE]:{type:u.FORESTER_LODGE,name:"Forester Lodge",category:k.RESOURCE,width:3,height:3,costLog:28,costStone:12,costIron:0,maxWorkers:4,workRadius:30,constructionWork:80,description:"Plants and harvests trees for logs. 4 workers."},[u.WOOD_CUTTER]:{type:u.WOOD_CUTTER,name:"Wood Cutter",category:k.RESOURCE,width:2,height:2,costLog:24,costStone:8,costIron:0,maxWorkers:1,workRadius:0,constructionWork:60,description:"Converts logs into firewood. 1 worker."},[u.BLACKSMITH]:{type:u.BLACKSMITH,name:"Blacksmith",category:k.RESOURCE,width:3,height:3,costLog:55,costStone:32,costIron:32,maxWorkers:1,workRadius:0,constructionWork:150,description:"Forges tools from iron and logs. 1 worker."},[u.TAILOR]:{type:u.TAILOR,name:"Tailor",category:k.RESOURCE,width:3,height:3,costLog:32,costStone:48,costIron:18,maxWorkers:1,workRadius:0,constructionWork:120,description:"Makes coats from leather. 1 worker."},[u.HERBALIST]:{type:u.HERBALIST,name:"Herbalist",category:k.SERVICES,width:3,height:3,costLog:26,costStone:10,costIron:0,maxWorkers:1,workRadius:30,constructionWork:80,description:"Gathers herbs to improve citizen health. 1 worker."},[u.MARKET]:{type:u.MARKET,name:"Market",category:k.SERVICES,width:5,height:5,costLog:60,costStone:40,costIron:16,maxWorkers:3,workRadius:40,constructionWork:200,description:"Distributes goods to nearby houses. 3 vendors."},[u.SCHOOL]:{type:u.SCHOOL,name:"School",category:k.SERVICES,width:4,height:4,costLog:82,costStone:80,costIron:40,maxWorkers:1,workRadius:0,constructionWork:250,description:"Educates children. Educated workers produce +50%. 1 teacher."},[u.TRADING_POST]:{type:u.TRADING_POST,name:"Trading Post",category:k.SERVICES,width:5,height:5,costLog:58,costStone:62,costIron:40,maxWorkers:2,workRadius:0,constructionWork:250,requiresWater:!0,description:"Trade with merchants. Must be placed near water. 2 workers."},[u.ROAD]:{type:u.ROAD,name:"Dirt Road",category:k.INFRASTRUCTURE,width:1,height:1,costLog:1,costStone:0,costIron:0,maxWorkers:0,workRadius:0,constructionWork:5,description:"Citizens walk 2x faster on roads. Cheap to build."}},x=[k.HOUSING,k.STORAGE,k.FOOD,k.RESOURCE,k.SERVICES,k.INFRASTRUCTURE],F=160,V=80,B=10,z=32,q=110;class li{game;selectedCategory=k.FOOD;constructor(t){this.game=t}handleClick(t,i){if(i<z){const a=Math.floor(t/q);a>=0&&a<x.length&&(this.selectedCategory=x[a]);return}const o=Object.values(J).filter(a=>a.category===this.selectedCategory),e=z+8,s=Math.floor((i-e)/(V+B)),n=Math.floor((t-B)/(F+B)),r=s*8+n;if(r>=0&&r<o.length){const a=o[r];this.game.state.placingBuilding=a.type}}draw(t,i,o){const e=o-Y;t.fillStyle="rgba(15, 15, 25, 0.95)",t.fillRect(0,e,i,Y),t.strokeStyle="#666",t.lineWidth=2,t.beginPath(),t.moveTo(0,e),t.lineTo(i,e),t.stroke();for(let r=0;r<x.length;r++){const a=r*q+4,l=x[r]===this.selectedCategory;t.fillStyle=l?"#3a5577":"#2a2a3a",t.fillRect(a,e+2,q-4,z-2),l&&(t.strokeStyle="#88aacc",t.lineWidth=1,t.strokeRect(a,e+2,q-4,z-2)),t.fillStyle=l?"#ffffff":"#999999",t.font="bold 13px monospace",t.fillText(x[r],a+8,e+21)}const s=Object.values(J).filter(r=>r.category===this.selectedCategory),n=e+z+8;for(let r=0;r<s.length;r++){const a=s[r],l=r%8,c=Math.floor(r/8),h=l*(F+B)+B,d=n+c*(V+B),f=this.game.getResource("log")>=a.costLog&&this.game.getResource("stone")>=a.costStone&&this.game.getResource("iron")>=a.costIron,w=this.game.state.placingBuilding===a.type;w?t.fillStyle="#3a5570":f?t.fillStyle="#2a3a4a":t.fillStyle="#3a2222",t.fillRect(h,d,F,V),t.strokeStyle=w?"#88ccff":f?"#556677":"#553333",t.lineWidth=w?2:1,t.strokeRect(h,d,F,V),t.fillStyle=f?"#ffffff":"#cc6666",t.font="bold 13px monospace",t.fillText(a.name,h+6,d+18),t.fillStyle="#bbbbbb",t.font="12px monospace";const p=[];a.costLog>0&&p.push(`L:${a.costLog}`),a.costStone>0&&p.push(`S:${a.costStone}`),a.costIron>0&&p.push(`I:${a.costIron}`),t.fillText(p.join(" ")||"Free",h+6,d+36),t.fillStyle="#999999",t.font="11px monospace";let S=`${a.width}x${a.height}`;a.maxWorkers>0&&(S+=`  Workers: ${a.maxWorkers}`),t.fillText(S,h+6,d+52),t.fillStyle="#777777",t.font="10px monospace";const C=Math.floor((F-12)/6),_=a.description.length>C?a.description.substring(0,C-2)+"..":a.description;t.fillText(_,h+6,d+68)}}}class ci{game;constructor(t){this.game=t}draw(t,i,o){const e=this.game.state.selectedEntity;if(e===null)return;const s=this.game.world;if(!s.entityExists(e)){this.game.state.selectedEntity=null;return}const n=i-wt,r=G+10,a=wt-10;t.fillStyle="rgba(20, 20, 30, 0.9)",t.fillRect(n,r,a,300),t.strokeStyle="#555",t.strokeRect(n,r,a,300);let l=r+20;const c=n+10;t.font="12px monospace";const h=s.getComponent(e,"citizen");if(h){t.fillStyle="#ffffff",t.font="bold 14px monospace",t.fillText(h.name,c,l),l+=20,t.font="12px monospace",t.fillStyle="#aaaaaa",t.fillText(`Age: ${h.age}  ${h.isMale?"Male":"Female"}`,c,l),l+=16,t.fillText(`${h.isChild?"Child":"Adult"}  ${h.isEducated?"Educated":"Uneducated"}`,c,l),l+=20;const f=s.getComponent(e,"needs");if(f&&(this.drawBar(t,c,l,a-20,"Food",f.food,"#44aa44"),l+=18,this.drawBar(t,c,l,a-20,"Energy",f.energy??100,"#ffdd44"),l+=18,this.drawBar(t,c,l,a-20,"Warmth",f.warmth,"#ff8844"),l+=18,this.drawBar(t,c,l,a-20,"Health",f.health,"#ff4444"),l+=18,this.drawBar(t,c,l,a-20,"Happy",f.happiness,"#44aaff"),l+=22),h.isSleeping&&(t.fillStyle="#aaaaff",t.font="bold 12px monospace",t.fillText("Sleeping...",c,l),l+=16),f?.isSick&&(t.fillStyle="#44dd44",t.font="bold 12px monospace",t.fillText("SICK",c,l),l+=16),f&&f.recentDiet&&f.recentDiet.length>0){const S=new Set(f.recentDiet).size,C=S>=3?"Varied":S===1?"Monotonous":"Limited",_=S>=3?"#44aa44":S===1?"#cc6644":"#aaaa44";t.fillStyle=_,t.font="11px monospace",t.fillText(`Diet: ${C} (${S} types)`,c,l),l+=16}const w=s.getComponent(e,"worker");w&&(t.fillStyle="#cccccc",t.fillText(`Job: ${w.profession}`,c,l),l+=16,w.carrying&&(t.fillText(`Carrying: ${w.carrying} x${w.carryAmount}`,c,l),l+=16));const p=s.getComponent(e,"family");if(p){if(p.partnerId!==null){const S=s.getComponent(p.partnerId,"citizen");t.fillText(`Partner: ${S?.name||"Unknown"}`,c,l),l+=16}p.childrenIds.length>0&&(t.fillText(`Children: ${p.childrenIds.length}`,c,l),l+=16),p.homeId!==null&&(t.fillText("Has home",c,l),l+=16)}return}const d=s.getComponent(e,"building");if(d){if(t.fillStyle="#ffffff",t.font="bold 14px monospace",t.fillText(d.name,c,l),l+=20,t.font="12px monospace",t.fillStyle="#aaaaaa",d.completed?(t.fillText("Completed",c,l),l+=16):(this.drawBar(t,c,l,a-20,"Construction",d.constructionProgress*100,"#ffaa44"),l+=22),t.fillText(`Size: ${d.width}x${d.height}`,c,l),l+=16,d.durability!==void 0){const p=d.durability>60?"#44aa44":d.durability>30?"#ddaa22":"#ff4444";this.drawBar(t,c,l,a-20,"Cond.",d.durability,p),l+=18}if(d.maxWorkers>0){const p=d.assignedWorkers?.length||0;t.fillText(`Workers: ${p}/${d.maxWorkers}`,c,l),l+=16}const f=s.getComponent(e,"house");f&&(t.fillText(`Residents: ${f.residents.length}/${f.maxResidents}`,c,l),l+=16,t.fillText(`Firewood: ${Math.floor(f.firewood)}`,c,l),l+=16,this.drawBar(t,c,l,a-20,"Warmth",f.warmthLevel,"#ff8844"),l+=22);const w=s.getComponent(e,"producer");w&&(t.fillText(`Active: ${w.active?"Yes":"No"}`,c,l),l+=16)}}drawBar(t,i,o,e,s,n,r){const a=e-60,l=12,c=i+55;t.fillStyle="#aaaaaa",t.font="10px monospace",t.fillText(s,i,o+10),t.fillStyle="#333",t.fillRect(c,o,a,l),t.fillStyle=r,t.fillRect(c,o,a*(n/100),l),t.fillStyle="#ffffff",t.fillText(`${Math.floor(n)}`,c+a+4,o+10)}}class hi{game;buffer;bufferCtx;dirty=!0;constructor(t){this.game=t,this.buffer=document.createElement("canvas"),this.buffer.width=T,this.buffer.height=T,this.bufferCtx=this.buffer.getContext("2d")}getPosition(t,i,o){const s=i?o+10:40;return{x:10,y:t-T-s}}handleClick(t,i){const o=Math.floor(t/T*M),e=Math.floor(i/T*D);this.game.camera.centerOn(o,e)}draw(t,i,o,e,s){const{x:n,y:r}=this.getPosition(o,e,s);this.dirty&&(this.renderBuffer(),this.dirty=!1),t.fillStyle="rgba(0, 0, 0, 0.5)",t.fillRect(n-2,r-2,T+4,T+4),t.drawImage(this.buffer,n,r),t.strokeStyle="#888",t.lineWidth=1,t.strokeRect(n,r,T,T);const a=this.game.camera,l=T/(M*32),c=T/(D*32),h=n+a.x*l,d=r+a.y*c,f=a.screenWidth/a.zoom*l,w=a.screenHeight/a.zoom*c;t.strokeStyle="#ffffff",t.lineWidth=1,t.strokeRect(h,d,f,w);const p=this.game.world.getComponentStore("citizen"),S=this.game.world.getComponentStore("position");if(p&&S){t.fillStyle="#ffff00";for(const[_]of p){const b=S.get(_);if(!b)continue;const v=n+b.tileX/M*T,N=r+b.tileY/D*T;t.fillRect(v,N,2,2)}}const C=this.game.world.getComponentStore("building");if(C&&S)for(const[_,b]of C){const v=S.get(_);if(!v)continue;t.fillStyle=b.completed?"#cc8833":"#ff8800";const N=n+v.tileX/M*T,E=r+v.tileY/D*T,O=Math.max(2,b.width/M*T),A=Math.max(2,b.height/D*T);t.fillRect(N,E,O,A)}}renderBuffer(){const t=this.bufferCtx,i=this.game.tileMap,o=t.createImageData(T,T),e=o.data;for(let s=0;s<T;s++)for(let n=0;n<T;n++){const r=Math.floor(n/T*M),a=Math.floor(s/T*D),l=i.get(r,a);if(!l)continue;const c=(s*T+n)*4,h=this.getTileColor(l.type);e[c]=h[0],e[c+1]=h[1],e[c+2]=h[2],e[c+3]=255}t.putImageData(o,0,0)}getTileColor(t){switch(t){case m.GRASS:return[74,140,63];case m.FOREST:return[45,107,36];case m.WATER:return[40,86,160];case m.STONE:return[138,138,138];case m.IRON:return[107,91,62];case m.RIVER:return[54,104,181];case m.FERTILE:return[90,156,74];default:return[74,140,63]}}invalidate(){this.dirty=!0}}class di{game;buildMenu;infoPanel;minimap;buildMenuOpen=!1;debugOverlay=!1;notifications=[];constructor(t){this.game=t,this.buildMenu=new li(t),this.infoPanel=new ci(t),this.minimap=new hi(t),t.eventBus.on("citizen_died",i=>{this.addNotification(`${i.name} has died`,"#ff4444")}),t.eventBus.on("citizen_born",()=>{this.addNotification("A child has been born!","#44ff44")}),t.eventBus.on("merchant_arrived",()=>{this.addNotification("A merchant has arrived!","#ffaa44")}),t.eventBus.on("new_year",i=>{this.addNotification(`Year ${i.year} begins`,"#ffffff")})}handleClick(t,i){const o=this.game.canvas;if(this.buildMenuOpen){const s=o.height-Y;if(i>=s)return this.buildMenu.handleClick(t,i-s),!0}if(i<G)return this.handleHUDClick(t,i),!0;const e=this.minimap.getPosition(o.height,this.buildMenuOpen,Y);return t>=e.x&&t<=e.x+T&&i>=e.y&&i<=e.y+T?(this.minimap.handleClick(t-e.x,i-e.y),!0):!1}handleHUDClick(t,i){const o=this.game.canvas;if(t>o.width-200){const e=[1,2,5,10],n=(e.indexOf(this.game.state.speed)+1)%e.length;this.game.state.speed=e[n],this.game.state.paused=!1}}toggleBuildMenu(){this.buildMenuOpen=!this.buildMenuOpen}closePanels(){this.buildMenuOpen=!1}addNotification(t,i){this.notifications.push({text:t,time:300,color:i}),this.notifications.length>5&&this.notifications.shift()}draw(t){const i=this.game.canvas;this.buildMenuOpen&&this.buildMenu.draw(t,i.width,i.height),t.fillStyle="rgba(0,0,0,0.7)",t.fillRect(i.width-100,i.height-30,90,25),t.fillStyle="#ffffff",t.font="12px monospace",t.fillText("[B] Build",i.width-95,i.height-13),this.game.state.selectedEntity!==null&&this.infoPanel.draw(t,i.width,i.height),this.minimap.draw(t,i.width,i.height,this.buildMenuOpen,Y),this.drawNotifications(t),this.drawSpeedControls(t,i.width),this.debugOverlay&&this.drawDebugOverlay(t,i.width,i.height),t.fillStyle="rgba(0,0,0,0.5)",t.fillRect(i.width-100,i.height-56,90,22),t.fillStyle="#888",t.font="10px monospace",t.fillText("[F3] Debug",i.width-95,i.height-40)}drawNotifications(t){let i=G+10;for(let o=this.notifications.length-1;o>=0;o--){const e=this.notifications[o];if(e.time--,e.time<=0){this.notifications.splice(o,1);continue}const s=Math.min(1,e.time/60);t.fillStyle=`rgba(0,0,0,${s*.7})`,t.fillRect(10,i,300,22),t.fillStyle=e.color,t.globalAlpha=s,t.font="12px monospace",t.fillText(e.text,15,i+15),t.globalAlpha=1,i+=25}}drawSpeedControls(t,i){const o=[1,2,5,10],e=i-180,s=8;t.font="12px monospace";for(let n=0;n<o.length;n++){const r=e+n*35,a=this.game.state.speed===o[n]&&!this.game.state.paused;t.fillStyle=a?"#44aa44":"rgba(255,255,255,0.3)",t.fillRect(r,s,30,22),t.fillStyle=a?"#fff":"#aaa",t.fillText(`${o[n]}x`,r+4,s+16)}this.game.state.paused&&(t.fillStyle="#ff4444",t.fillRect(e+145,s,35,22),t.fillStyle="#fff",t.fillText("||",e+152,s+16))}drawDebugOverlay(t,i,o){const e=this.game.world,s=this.game.camera,n=e.getComponentStore("citizen"),r=e.getComponentStore("position"),a=e.getComponentStore("worker"),l=e.getComponentStore("movement"),c=e.getComponentStore("needs");if(!n||!r)return;let h=0,d=0,f=0,w=0;const p=new Map;for(const[E]of n){const O=l?.get(E),A=a?.get(E);if(O?.moving?d++:O?.stuckTicks>30?h++:f++,A?.workplaceId!==null&&A?.workplaceId!==void 0&&w++,A){const P=A.profession||"laborer";p.set(P,(p.get(P)||0)+1)}}const S=10,C=G+10,_=240,b=["-- DEBUG (F3) --",`Entities: ${e.getEntityCount()}`,`Citizens: ${n.size}`,`Moving: ${d}  Idle: ${f}  Stuck: ${h}`,`Assigned: ${w}  Unassigned: ${n.size-w}`,`Tick: ${this.game.state.tick}`,"","Professions:"];for(const[E,O]of p)b.push(`  ${E}: ${O}`);b.push(""),b.push("Resources:");for(const[E,O]of this.game.globalResources)O>0&&b.push(`  ${E}: ${Math.floor(O)}`);const v=14,N=b.length*v+10;t.fillStyle="rgba(0, 0, 0, 0.85)",t.fillRect(S,C,_,N),t.strokeStyle="#666",t.strokeRect(S,C,_,N),t.font="11px monospace";for(let E=0;E<b.length;E++)t.fillStyle=b[E].includes("Stuck")&&h>0?"#ff6644":"#cccccc",t.fillText(b[E],S+6,C+14+E*v);for(const[E]of n){const O=r.get(E);if(!O)continue;const A=s.worldToScreen(O.tileX*32+16,O.tileY*32+16);if(A.x<0||A.x>i||A.y<0||A.y>o)continue;const P=l?.get(E),Q=a?.get(E),U=c?.get(E);let L="",W="#88ff88";P?.stuckTicks>30?(L="STUCK",W="#ff4444"):P?.moving?(L="moving",W="#88ff88"):Q?.workplaceId!==null&&Q?.workplaceId!==void 0?(L=Q.profession?.substring(0,6)||"work",W="#88aaff"):(L="idle",W="#aaaaaa"),U&&U.food<20&&(L+=" HUNGRY",W="#ffaa44"),U&&U.health<30&&(L+=" DYING",W="#ff4444"),t.fillStyle=W,t.font="9px monospace",t.fillText(L,A.x-15,A.y-12)}}}class fi{game;constructor(t){this.game=t}tryPlace(t,i){const o=this.game.state.placingBuilding;if(!o)return;const e=J[o];if(!e)return;const s=this.game.camera.screenToTile(t,i),n=s.x-Math.floor(e.width/2),r=s.y-Math.floor(e.height/2);if(this.game.getResource("log")<e.costLog||this.game.getResource("stone")<e.costStone||this.game.getResource("iron")<e.costIron)return;if(o===u.ROAD){this.placeRoad(n,r,e);return}if(!this.canPlace(n,r,e))return;const a=this.game.world.createEntity();this.game.world.addComponent(a,"position",{tileX:n,tileY:r,pixelX:n*g,pixelY:r*g}),this.game.world.addComponent(a,"building",{type:e.type,name:e.name,category:e.category,completed:e.constructionWork<=10,constructionProgress:e.constructionWork<=10?1:0,constructionWork:e.constructionWork,width:e.width,height:e.height,maxWorkers:e.maxWorkers,workRadius:e.workRadius,assignedWorkers:[],costLog:e.costLog,costStone:e.costStone,costIron:e.costIron,materialsDelivered:!1,isStorage:e.isStorage,storageCapacity:e.storageCapacity,residents:e.residents}),this.game.world.addComponent(a,"renderable",{sprite:null,layer:5,animFrame:0,visible:!0}),this.game.tileMap.markOccupied(n,r,e.width,e.height,a),e.constructionWork<=10&&(e.isStorage&&this.game.world.addComponent(a,"storage",{inventory:new Map,capacity:e.storageCapacity||5e3}),e.costLog>0&&this.game.removeResource("log",e.costLog),e.costStone>0&&this.game.removeResource("stone",e.costStone),e.costIron>0&&this.game.removeResource("iron",e.costIron))}placeRoad(t,i,o){this.game.tileMap.placeRoad(t,i)&&(o.costLog>0&&this.game.removeResource("log",o.costLog),o.costStone>0&&this.game.removeResource("stone",o.costStone),this.game.pathfinder.clearCache())}canPlace(t,i,o){return!(!this.game.tileMap.isAreaBuildable(t,i,o.width,o.height)||o.requiresWater&&!this.game.tileMap.hasAdjacentWater(t,i,o.width,o.height))}getGhostData(){const t=this.game.state.placingBuilding;if(!t)return[];const i=J[t];if(!i)return[];const o=this.game.input,e=this.game.camera.screenToTile(o.mouseX,o.mouseY),s=e.x-Math.floor(i.width/2),n=e.y-Math.floor(i.height/2);let r;return t===u.ROAD?r=!!this.game.tileMap.get(s,n)&&this.game.tileMap.isWalkable(s,n)&&this.game.getResource("log")>=i.costLog:r=this.canPlace(s,n,i)&&this.game.getResource("log")>=i.costLog&&this.game.getResource("stone")>=i.costStone&&this.game.getResource("iron")>=i.costIron,[{x:s,y:n,w:i.width,h:i.height,valid:r}]}}class ui{canvas;eventBus=new Le;rng;tileMap;camera;input;world;pathfinder;cameraController;placementController;renderSystem;movementSystem;citizenAI;constructionSystem;productionSystem;needsSystem;storageSystem;populationSystem;seasonSystem;tradeSystem;environmentSystem;diseaseSystem;particleSystem;weatherSystem;uiManager;loop;state;globalResources=new Map;constructor(t,i){this.canvas=t,this.rng=new It(i??Date.now()),this.resizeCanvas(),window.addEventListener("resize",()=>this.resizeCanvas()),this.tileMap=new We;const o=new He;o.generate(this.tileMap,this.rng.int(0,999999)),this.camera=new Be(t.width,t.height);const e=o.findStartLocation(this.tileMap);this.camera.centerOn(e.x,e.y),this.input=new Pe(t),this.cameraController=new xe(this.camera,this.input),this.world=new Ye,this.pathfinder=new Xe(this.tileMap),this.state={tick:0,year:1,subSeason:0,tickInSubSeason:0,speed:1,paused:!1,population:0,totalDeaths:0,totalBirths:0,selectedEntity:null,placingBuilding:null,gameOver:!1,dayProgress:.3,isNight:!1,isDusk:!1,isDawn:!1,nightAlpha:0};for(const[s,n]of Object.entries(Kt))this.globalResources.set(s,n);this.renderSystem=new Ge(t,this.camera,this.tileMap),this.movementSystem=new Ke(this.world,this.tileMap),this.citizenAI=new $e(this),this.constructionSystem=new Ve(this),this.productionSystem=new je(this),this.needsSystem=new Ze(this),this.storageSystem=new Je(this),this.populationSystem=new ei(this),this.seasonSystem=new ii(this),this.tradeSystem=new si(this),this.environmentSystem=new oi(this),this.diseaseSystem=new ni(this),this.particleSystem=new ri(this),this.weatherSystem=new ai(this),this.uiManager=new di(this),this.placementController=new fi(this),this.input.onClick((s,n,r)=>{if(r===2&&this.state.placingBuilding){this.state.placingBuilding=null;return}if(r===0){if(this.uiManager.handleClick(s,n))return;if(this.state.placingBuilding){this.placementController.tryPlace(s,n);return}this.selectEntityAt(s,n)}}),this.spawnStartingCitizens(e.x,e.y),this.createStartingStockpile(e.x,e.y),this.loop=new Ne(s=>this.update(s),s=>this.render(s))}start(){this.loop.start()}resizeCanvas(){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.camera?.resize(this.canvas.width,this.canvas.height)}update(t){if(this.state.gameOver)return;this.state.tick++,this.seasonSystem.update(),this.citizenAI.update(),this.movementSystem.update(),this.constructionSystem.update(),this.productionSystem.update(),this.needsSystem.update(),this.storageSystem.update(),this.populationSystem.update(),this.tradeSystem.update(),this.environmentSystem.update(),this.diseaseSystem.update(),this.particleSystem.update(),this.weatherSystem.update();const i=this.world.getComponentStore("citizen");this.state.population=i?i.size:0,this.state.tick>100&&this.state.population===0&&(this.state.gameOver=!0)}render(t){this.cameraController.update(1/60),this.handleKeyboardShortcuts();const i=this.getCitizenRenderData(),o=this.getBuildingRenderData(),e=this.placementController.getGhostData(),s=n=>this.particleSystem.draw(n);this.renderSystem.render(t,this.state,{citizens:i,buildings:o,ghosts:e,drawParticles:s}),this.uiManager.draw(this.canvas.getContext("2d")),this.renderSystem.drawHUD(this.state,this.globalResources,this.weatherSystem.currentWeather)}handleKeyboardShortcuts(){this.input.isKeyDown(" ")&&(this.state.paused=!this.state.paused,this.loop.setSpeed(this.state.paused?0:this.state.speed),this.input.keys.delete(" ")),this.input.isKeyDown("b")&&(this.uiManager.toggleBuildMenu(),this.input.keys.delete("b")),this.input.isKeyDown("escape")&&(this.state.placingBuilding=null,this.state.selectedEntity=null,this.uiManager.closePanels(),this.input.keys.delete("escape")),this.input.isKeyDown("r")&&this.state.gameOver&&(this.restart(),this.input.keys.delete("r")),this.input.isKeyDown("f3")&&(this.uiManager.debugOverlay=!this.uiManager.debugOverlay,this.input.keys.delete("f3"));for(let t=0;t<St.length;t++)this.input.isKeyDown(String(t+1))&&(this.state.speed=St[t],this.state.paused=this.state.speed===0,this.loop.setSpeed(this.state.speed),this.input.keys.delete(String(t+1)))}restart(){window.location.reload()}spawnStartingCitizens(t,i){for(let o=0;o<rt+Nt;o++){const e=o>=rt,s=o%2===0,n=e?this.rng.int(1,8):this.rng.int(18,35),r=this.rng.int(-3,3),a=this.rng.int(-3,3),l=t+r,c=i+a,h=this.world.createEntity();this.world.addComponent(h,"position",{tileX:l,tileY:c,pixelX:l*g+g/2,pixelY:c*g+g/2}),this.world.addComponent(h,"citizen",{name:this.generateName(s),age:n,isMale:s,isChild:e,isEducated:!1,isSleeping:!1}),this.world.addComponent(h,"movement",{path:[],speed:ot,targetEntity:null,moving:!1}),this.world.addComponent(h,"worker",{profession:I.LABORER,workplaceId:null,carrying:null,carryAmount:0,task:null}),this.world.addComponent(h,"needs",{food:80+this.rng.int(0,20),warmth:100,health:100,happiness:80+this.rng.int(0,20),energy:80+this.rng.int(0,20)}),this.world.addComponent(h,"family",{partnerId:null,childrenIds:[],homeId:null}),this.world.addComponent(h,"renderable",{sprite:null,layer:10,animFrame:0,visible:!0})}}createStartingStockpile(t,i){const o=t+3,e=i+3;if(this.tileMap.isAreaBuildable(o,e,4,4)){const s=this.world.createEntity();this.world.addComponent(s,"position",{tileX:o,tileY:e,pixelX:o*g,pixelY:e*g}),this.world.addComponent(s,"building",{type:u.STOCKPILE,completed:!0,constructionProgress:1,width:4,height:4,category:"Storage",name:"Stockpile",maxWorkers:0,workRadius:0,assignedWorkers:[]}),this.world.addComponent(s,"storage",{inventory:new Map,capacity:5e3}),this.world.addComponent(s,"renderable",{sprite:null,layer:5,animFrame:0,visible:!0}),this.tileMap.markOccupied(o,e,4,4,s)}}generateName(t){const i=["John","William","Thomas","Richard","Henry","Robert","Edward","George","James","Arthur"],o=["Mary","Elizabeth","Anne","Margaret","Catherine","Jane","Alice","Eleanor","Rose","Sarah"];return t?this.rng.pick(i):this.rng.pick(o)}selectEntityAt(t,i){const o=this.camera.screenToTile(t,i),e=this.world.getComponentStore("position"),s=this.world.getComponentStore("citizen");if(e&&s){let r=null,a=2;for(const[l]of s){const c=e.get(l);if(!c)continue;const h=c.tileX-o.x,d=c.tileY-o.y,f=Math.sqrt(h*h+d*d);f<a&&(a=f,r=l)}if(r!==null){this.state.selectedEntity=r;return}}const n=this.tileMap.get(o.x,o.y);if(n?.buildingId){this.state.selectedEntity=n.buildingId;return}this.state.selectedEntity=null}getCitizenRenderData(){const t=[],i=this.world.getComponentStore("position"),o=this.world.getComponentStore("citizen"),e=this.world.getComponentStore("needs");if(!i||!o)return t;for(const[s,n]of o){const r=i.get(s);if(!r)continue;const a=e?.get(s);t.push({id:s,x:r.tileX,y:r.tileY,isMale:n.isMale,isChild:n.isChild,health:a?.health??100,isSleeping:n.isSleeping??!1,isSick:a?.isSick??!1,isChatting:(n.chatTimer??0)>0})}return t}getBuildingRenderData(){const t=[],i=this.world.getComponentStore("position"),o=this.world.getComponentStore("building");if(!i||!o)return t;for(const[e,s]of o){const n=i.get(e);n&&t.push({id:e,x:n.tileX,y:n.tileY,w:s.width,h:s.height,category:s.category,completed:s.completed,progress:s.constructionProgress,name:s.name,type:s.type})}return t}getResource(t){return this.globalResources.get(t)||0}addResource(t,i){this.globalResources.set(t,(this.globalResources.get(t)||0)+i)}removeResource(t,i){const o=this.globalResources.get(t)||0,e=Math.min(o,i);return this.globalResources.set(t,o-e),e}getTotalFood(){let t=0;for(const i of j)t+=this.getResource(i);return t+=this.getResource("food"),t}removeFood(t){let i=t;i-=this.removeResource("food",i);for(const o of j){if(i<=0)break;i-=this.removeResource(o,i)}return t-i}removeFoodPreferVariety(t,i){const o=new Map;for(const r of i)o.set(r,(o.get(r)||0)+1);const e=[];this.getResource("food")>=t&&e.push({type:"food",count:o.get("food")||0});for(const r of j)this.getResource(r)>=t&&e.push({type:r,count:o.get(r)||0});if(e.length===0)return{eaten:this.removeFood(t),type:"food"};e.sort((r,a)=>r.count-a.count);const s=e[0];return{eaten:this.removeResource(s.type,t),type:s.type}}}const bt=document.getElementById("game");if(!bt)throw new Error("Canvas not found");const Mt=new ui(bt);Mt.start();window.game=Mt;
